<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout Analyzer - Decision Hub</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ecf0f1;
        }

        .container {
            text-align: center;
            max-width: 600px;
            width: 90%;
        }

        header {
            margin-bottom: 50px;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00e676, #2980b9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #bbb;
            margin-bottom: 30px;
            font-weight: 300;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .option-card {
            background: #2a2a3e;
            border: 2px solid #444;
            border-radius: 12px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .option-card:hover {
            border-color: #00e676;
            background: #333350;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 230, 118, 0.2);
        }

        .option-card.purple {
            border-color: #9b59b6;
        }

        .option-card.purple:hover {
            border-color: #c39bd3;
            box-shadow: 0 10px 30px rgba(155, 89, 182, 0.3);
        }

        .option-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .option-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .option-desc {
            font-size: 0.9rem;
            color: #aaa;
            line-height: 1.4;
        }

        .info-section {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #00e676;
            padding: 15px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: left;
        }

        .info-section h3 {
            color: #00e676;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .info-section p {
            font-size: 0.85rem;
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .info-section p:last-child {
            margin-bottom: 0;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #333;
            border: 1px solid #555;
            color: #fff;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
            display: inline-block;
            transition: 0.2s;
        }

        .back-btn:hover {
            background: #444;
            border-color: #666;
        }

        @media (max-width: 600px) {
            .options {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2rem;
            }

            .container {
                width: 95%;
            }
        }
    </style>
</head>
<body>

    <a href="#" class="back-btn" onclick="window.history.back(); return false;">‚Üê Atr√°s</a>

    <div class="container">
        <header>
            <h1>üéØ SCOUT ANALYZER</h1>
            <div class="subtitle">Sistema avanzado de an√°lisis de jugadores</div>
        </header>

        <div class="options">
            <!-- Opci√≥n 1: PDF Report -->
            <a href="javascript:void(0)" class="option-card" onclick="openPDFReportModal()">
                <div class="option-icon">üìÑ</div>
                <div class="option-title">Generar PDF</div>
                <div class="option-desc">Descarga un informe profesional en PDF con estad√≠sticas y an√°lisis</div>
            </a>

            <!-- Opci√≥n 2: Advanced Scout -->
            <a href="javascript:void(0)" class="option-card purple" onclick="window.location.href='/AttackMetrics.html'">
                <div class="option-icon">üçï</div>
                <div class="option-title">Attack Scout Pro</div>
                <div class="option-desc">Herramienta avanzada de an√°lisis con b√∫squeda de jugadores similares</div>
            </a>
        </div>

        <div class="info-section">
            <h3>üí° ¬øC√≥mo usar?</h3>
            <p><strong>üìÑ Generar PDF:</strong> Carga datos en formato XLSX y descarga un reporte profesional con gr√°ficos y an√°lisis de percentiles.</p>
            <p><strong>üçï Attack Scout Pro:</strong> Sistema completo de an√°lisis con pizza charts, scatter plots y b√∫squeda de jugadores similares mediante algoritmo ponderado.</p>
        </div>
    </div>

    <!-- Modal para generador de PDF -->
    <div id="pdfModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; display:flex; align-items:center; justify-content:center; flex-direction:column;">
        <div style="background:#2a2a3e; border-radius:12px; padding:40px; max-width:500px; width:90%; text-align:center;">
            <h2 style="margin-bottom:20px; color:#00e676;">üìä Generar Informe PDF</h2>
            
            <div style="margin-bottom:20px; text-align:left;">
                <label style="display:block; color:#aaa; font-size:0.8rem; margin-bottom:8px; font-weight:bold;">CARGAR DATOS (XLSX)</label>
                <input type="file" id="pdfFileInput" accept=".xlsx" style="width:100%; background:#111; color:#fff; border:1px solid #444; padding:10px; border-radius:6px;">
            </div>

            <div style="margin-bottom:20px; text-align:left;">
                <label style="display:block; color:#aaa; font-size:0.8rem; margin-bottom:8px; font-weight:bold;">SELECCIONAR JUGADOR</label>
                <select id="pdfPlayerSelect" style="width:100%; background:#111; color:#fff; border:1px solid #444; padding:10px; border-radius:6px;">
                    <option>Carga datos primero...</option>
                </select>
            </div>

            <div style="display:flex; gap:10px;">
                <button onclick="closePDFModal()" style="flex:1; background:#555; color:#fff; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold;">Cancelar</button>
                <button onclick="generateAndDownloadPDF()" style="flex:1; background:#00e676; color:#000; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold;">Generar PDF</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        let PDF_RAW_DB = [];
        let PDF_NORMALIZED_DB = [];

        function openPDFReportModal() {
            document.getElementById('pdfModal').style.display = 'flex';
        }

        function closePDFModal() {
            document.getElementById('pdfModal').style.display = 'none';
        }

        document.getElementById('pdfFileInput').addEventListener('change', async function() {
            const files = this.files;
            if (!files.length) return;

            const pMap = {};
            for (let f of files) {
                await new Promise(res => {
                    const r = new FileReader();
                    r.onload = e => {
                        try {
                            const wb = XLSX.read(e.target.result, { type: 'array' });
                            const ws = wb.Sheets["Jugadores"];
                            if (ws) {
                                XLSX.utils.sheet_to_json(ws).forEach(row => {
                                    const name = row["Jugador"];
                                    if (!name) return;
                                    const team = row["Equipo"] || "Free Agent";
                                    const pos = row["Posicion"] || "N/A";
                                    const age = row["Edad"] || 25;
                                    const id = `${name}|${team}`;
                                    
                                    if (!pMap[id]) pMap[id] = { id, name, team, pos, age, matches: 0, stats: {} };
                                    pMap[id].matches++;
                                    
                                    ['xG', 'xBuild', 'xThreat', 'Creacion', 'Ataque', 'Defensa', 'Pases'].forEach(m => {
                                        if (!pMap[id].stats[m]) pMap[id].stats[m] = 0;
                                        pMap[id].stats[m] += (row[m] || 0);
                                    });
                                });
                            }
                        } catch (err) { console.error(err); }
                        res();
                    };
                    r.readAsArrayBuffer(f);
                });
            }

            PDF_RAW_DB = Object.values(pMap).map(p => {
                const obj = { id: p.id, name: p.name, team: p.team, pos: p.pos, age: p.age };
                ['xG', 'xBuild', 'xThreat', 'Creacion', 'Ataque', 'Defensa', 'Pases'].forEach(m => {
                    obj[m] = p.stats[m] / p.matches;
                });
                return obj;
            });

            // Normalizar datos
            const maxs = {};
            ['xG', 'xBuild', 'xThreat', 'Creacion', 'Ataque', 'Defensa', 'Pases'].forEach(m => maxs[m] = 0);
            PDF_RAW_DB.forEach(p => ['xG', 'xBuild', 'xThreat', 'Creacion', 'Ataque', 'Defensa', 'Pases'].forEach(m => {
                if (p[m] > maxs[m]) maxs[m] = p[m];
            }));

            PDF_NORMALIZED_DB = PDF_RAW_DB.map(p => {
                const n = { ...p, raw: { ...p } };
                ['xG', 'xBuild', 'xThreat', 'Creacion', 'Ataque', 'Defensa', 'Pases'].forEach(m => {
                    n[m] = maxs[m] ? p[m] / maxs[m] : 0;
                });
                return n;
            });

            // Poblar select
            const sel = document.getElementById('pdfPlayerSelect');
            sel.innerHTML = '<option value="">Selecciona Jugador...</option>';
            PDF_RAW_DB.sort((a, b) => a.name.localeCompare(b.name)).forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.text = `${p.name} (${p.team})`;
                sel.appendChild(opt);
            });
        });

        function calculatePercentil(metric, value, dataset) {
            const lowerCount = dataset.filter(p => p[metric] < value).length;
            return Math.round((lowerCount / dataset.length) * 100);
        }

        async function generateAndDownloadPDF() {
            const playerId = document.getElementById('pdfPlayerSelect').value;
            if (!playerId) {
                alert('Selecciona un jugador');
                return;
            }

            const target = PDF_NORMALIZED_DB.find(p => p.id === playerId);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            const METRICS = ['xG', 'xBuild', 'xThreat', 'Creacion', 'Ataque', 'Defensa', 'Pases'];
            const METRIC_LABELS = {
                'xG': 'Goles Esp.', 'xBuild': 'Construcci√≥n', 'xThreat': 'Amenaza (xT)',
                'Creacion': 'Creaci√≥n', 'Ataque': 'Ataque Dir.', 'Defensa': 'Defensa', 'Pases': 'Pases'
            };

            // === PORTADA ===
            doc.setFillColor(26, 26, 46);
            doc.rect(0, 0, 210, 70, 'F');
            
            doc.setTextColor(0, 230, 118);
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.text('SCOUT ANALYZER', 105, 25, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(255, 255, 255);
            doc.text('Informe de Rendimiento', 105, 35, { align: 'center' });
            
            doc.setFillColor(0, 230, 118);
            doc.rect(40, 40, 130, 1, 'F');
            
            doc.setFontSize(16);
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text(target.name, 105, 55, { align: 'center' });
            
            doc.setFontSize(9);
            doc.setTextColor(200, 200, 200);
            doc.setFont(undefined, 'normal');
            doc.text(`${target.team} (${target.pos}) | Edad: ${target.age}`, 105, 65, { align: 'center' });

            let yPos = 80;

            // === TABLA DE PERCENTILES ===
            doc.setFillColor(26, 26, 46);
            doc.rect(15, yPos, 180, 8, 'F');
            doc.setFontSize(11);
            doc.setTextColor(0, 230, 118);
            doc.setFont(undefined, 'bold');
            doc.text('ANALISIS DE PERCENTILES', 20, yPos + 5, { align: 'left' });
            yPos += 10;

            const tableData = METRICS.map(m => {
                const pct = calculatePercentil(m, target[m], PDF_NORMALIZED_DB);
                return [METRIC_LABELS[m], target.raw[m].toFixed(2), `P${pct}`];
            });

            doc.autoTable({
                startY: yPos,
                head: [['M√©trica', 'Valor', 'Percentil']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [0, 230, 118], textColor: [26, 26, 46], fontStyle: 'bold' },
                bodyStyles: { fontSize: 10, textColor: [255, 255, 255] },
                alternateRowStyles: { fillColor: [45, 45, 60] },
                styles: { cellPadding: 3, lineColor: [100, 100, 120], lineWidth: 0.5 }
            });

            yPos = doc.lastAutoTable.finalY + 10;

            // === COMPARATIVA CON TOP 3 ===
            const topPlayers = PDF_NORMALIZED_DB
                .filter(p => p.id !== target.id)
                .sort((a, b) => {
                    let scoreA = 0, scoreB = 0;
                    METRICS.forEach(m => { scoreA += a[m]; scoreB += b[m]; });
                    return scoreB - scoreA;
                })
                .slice(0, 3);

            if (topPlayers.length > 0) {
                if (yPos > 200) {
                    doc.addPage();
                    yPos = 15;
                }

                doc.setFillColor(26, 26, 46);
                doc.rect(15, yPos, 180, 8, 'F');
                doc.setFontSize(11);
                doc.setTextColor(0, 230, 118);
                doc.setFont(undefined, 'bold');
                doc.text('JUGADORES TOP SIMILARES', 20, yPos + 5, { align: 'left' });
                yPos += 10;

                const similarData = topPlayers.map(p => {
                    let score = 0;
                    METRICS.forEach(m => { score += p[m]; });
                    return [p.name, p.team, (score / METRICS.length * 100).toFixed(1) + '%'];
                });

                doc.autoTable({
                    startY: yPos,
                    head: [['Jugador', 'Equipo', 'Score']],
                    body: similarData,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 230, 118], textColor: [26, 26, 46], fontStyle: 'bold' },
                    bodyStyles: { fontSize: 9, textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [45, 45, 60] }
                });
            }

            // === PIE ===
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFillColor(26, 26, 46);
                doc.rect(0, 287, 210, 10, 'F');
                doc.setFontSize(8);
                doc.setTextColor(0, 230, 118);
                doc.text(`Scout Analyzer v1.0 ‚Ä¢ P√°gina ${i} de ${pageCount}`, 105, 291, { align: 'center' });
            }

            doc.save(`Informe_${target.name.replace(/ /g, '_')}_${target.team}.pdf`);
            closePDFModal();
        }

        // Cerrar modal al hacer click fuera
        document.getElementById('pdfModal').addEventListener('click', function(e) {
            if (e.target === this) closePDFModal();
        });
    </script>

</body>
</html>
