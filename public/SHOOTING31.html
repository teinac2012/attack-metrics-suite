<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Match Data Hub - Pro Scout v18.11 (Calibraci√≥n Fina xGOT)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* [ESTILOS EXACTOS - MANTENIDOS] */
        :root { --bg-dark: #0f0f13; --panel-bg: #18181c; --border: #2d2d33; --accent-blue: #3498db; --accent-red: #e74c3c; --accent-brand: #f39c12; --text-main: #ffffff; }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 0; height: 100vh; width: 100vw; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 40px; background: #000; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; flex-shrink: 0; z-index: 100; }
        .logo { font-weight: 900; letter-spacing: 1px; font-size: 0.9rem; text-transform: uppercase; font-style: italic;}
        .logo span { color: var(--accent-brand); }
        .header-inputs { display: flex; gap: 10px; align-items: center; }
        .input-jornada { background: #222; border: 1px solid #444; color: #fff; padding: 2px 8px; border-radius: 4px; width: 50px; text-align: center; font-weight: bold; font-size: 0.8rem; }
        .tools button { background: #2d3436; color: #fff; border: 1px solid #444; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; margin-left: 5px; white-space: nowrap; font-weight: bold; }
        .btn-excel { background: var(--accent-brand); border-color: var(--accent-brand); color: #000 !important; }
        .btn-season { background: #8e44ad; border-color: #9b59b6; }
        .btn-save-season { background: #27ae60; border-color: #2ecc71; }
        .btn-radar { background: #e67e22; border-color: #d35400; }
        .btn-heat { background: #d35400; border-color: #e67e22; }
        .btn-timeline { background: #34495e; border-color: #57606f; }
        .btn-loose { background: #7f8c8d; border-color: #95a5a6; }
        
        /* LAYOUT & VISUAL FIXES */
        .layout { display: flex; flex: 1; overflow: hidden; height: calc(100vh - 40px); }
        .vis-col { flex: 70; display: flex; flex-direction: column; border-right: 1px solid var(--border); padding: 10px; gap: 10px; background: #000; position: relative; overflow: hidden; min-width: 300px; }
        
        .pitch-container { flex: 1; position: relative; border: 1px solid #333; border-radius: 6px; overflow: hidden; background: #1e272e; display: flex; justify-content: center; align-items: center; min-height: 300px; }
        .goal-container { flex: 0 0 240px; position: relative; border: 1px solid #333; border-radius: 6px; overflow: hidden; background: #dfe6e9; min-height: 240px; }
        
        .metrics-overlay { position: absolute; top: 15px; left: 15px; z-index: 10; display: flex; gap: 10px; pointer-events: none; }
        .metric-box { background: rgba(0,0,0,0.85); padding: 5px 10px; border-radius: 6px; border-left: 3px solid var(--accent-brand); min-width: 80px; }
        .metric-val { font-size: 1.1rem; font-weight: 800; display: block; line-height: 1; }
        .metric-lbl { font-size: 0.55rem; color: #aaa; text-transform: uppercase; }
        .metric-zone { font-size: 0.6rem; color: var(--accent-brand); margin-top:2px; font-weight:bold; text-transform:uppercase; display:block;}
        .btn-camera { position: absolute; top: 10px; right: 10px; z-index: 20; background: rgba(0,0,0,0.6); color: #fff; border: 1px solid #555; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 1.2rem; transition: background 0.2s; }
        .btn-camera:hover { background: var(--accent-brand); color: #000; }
        
        .chart-title-overlay { position: absolute; top: 5px; left: 5px; font-size: 0.6rem; color: #666; font-weight: bold; text-transform: uppercase; z-index: 5; }
        canvas { display: block; touch-action: none; width: 100%; height: 100%; } 
        
        .data-col { flex: 30; display: flex; flex-direction: column; background: var(--panel-bg); min-width: 320px; overflow: hidden; }
        .scoreboard { flex: 0 0 auto; display: grid; grid-template-columns: 1fr auto 1fr; gap: 5px; padding: 10px; background: #222; border-bottom: 1px solid var(--border); align-items: center; }
        .sb-team { text-align: center; }
        .sb-name { font-size: 0.7rem; font-weight: bold; color: #888; display: block; margin-bottom: 2px; }
        .sb-score { font-size: 1.5rem; font-weight: 800; }
        .sb-div { font-size: 0.8rem; color: #555; font-weight: bold; }
        .ts-home { color: var(--accent-blue); }
        .ts-away { color: var(--accent-red); }
        .charts-wrapper { flex: 0 0 90px; display: flex; border-bottom: 1px solid var(--border); background: #161616; }
        .chart-container { flex: 1; position: relative; padding: 5px; border-right: 1px solid #222; }
        .chart-title { position: absolute; top: 3px; left: 5px; font-size: 0.5rem; color: #666; text-transform: uppercase; font-weight: bold; }
        .controls-area { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .ctrl-group { background: #2b2b2b; padding: 8px; border-radius: 6px; border: 1px solid #3a3a3a; flex-shrink: 0; }
        .ctrl-header { font-size: 0.65rem; color: var(--accent-brand); text-transform: uppercase; font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 4px; }
        .row { display: flex; gap: 8px; margin-bottom: 5px; }
        select, input { width: 100%; background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 6px; border-radius: 4px; font-size: 0.8rem; }
        label.slider-lbl { display: flex; justify-content: space-between; font-size: 0.65rem; color: #ccc; margin-top: 4px; }
        .time-input-group { display: flex; gap: 5px; align-items: center; }
        .time-input-group input { text-align: center; font-family: monospace; font-weight: bold; font-size: 0.9rem; }
        .player-input-row { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; margin-bottom: 5px;}
        .player-input-row input { font-weight: bold; color: #fff; border-color: #555; background: #222; }
        .btns-row { display: flex; gap: 10px; padding-bottom: 10px; }
        .btn-act { flex: 1; padding: 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 800; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; transition: opacity 0.1s; }
        .btn-act:active { opacity: 0.8; }
        .btn-home { background: var(--accent-blue); }
        .btn-away { background: var(--accent-red); }
        .btn-badge { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: normal; }
        .log-area { flex: 0 0 120px; background: #151515; border-top: 1px solid var(--border); overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
        th { position: sticky; top: 0; background: #222; color: #999; text-align: left; padding: 4px 8px; font-weight: 600; z-index: 2;}
        td { border-bottom: 1px solid #222; padding: 4px 8px; color: #ccc; vertical-align: middle; }
        tr:nth-child(even) { background: #1a1a1a; }
        .btn-del-row { background: #e74c3c; color: #fff; border: none; border-radius: 3px; width: 20px; height: 20px; font-size: 12px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-edit-row { background: #f39c12; color: #fff; border: none; border-radius: 3px; width: 20px; height: 20px; font-size: 10px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin-left: 2px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #18181c; width: 95%; max-width: 1100px; height: 90vh; border: 1px solid #333; border-radius: 8px; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: var(--accent-brand); }
        .modal-tools { display: flex; gap: 10px; flex-wrap: wrap;}
        .btn-close { background: #555; color: #fff; border: 1px solid #777; padding: 5px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-action { background: #3498db; color: #fff; border: none; padding: 5px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; display: flex; align-items: center; gap: 5px;}
        .btn-delete { background: #c0392b; color: #fff; border: none; padding: 5px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .radar-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: 100%; }
        .radar-panel { background: #111; padding: 15px; border-radius: 6px; overflow-y:auto; display: flex; flex-direction: column; gap: 15px;}
        .radar-box { background: #161616; border-radius: 6px; display: flex; justify-content: center; align-items: center; position: relative; border: 1px solid #333;}
        .radar-player-list { display: flex; flex-direction: column; gap: 8px; }
        .rp-card { background: #222; border-radius: 4px; border-left: 4px solid #555; padding: 8px; position: relative; }
        .rp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .rp-name { font-weight: bold; font-size: 0.85rem; color: #fff; }
        .rp-stats { display: flex; gap: 8px; font-size: 0.7rem; color: #aaa; }
        .rp-remove { background: none; border: none; color: #e74c3c; cursor: pointer; font-weight: bold; font-size: 1rem; padding: 0 5px; }
        .importer-box { background: #2a2a2e; padding: 10px; border-radius: 4px; border: 1px dashed #444; }
        .importer-title { font-size: 0.7rem; color: var(--accent-brand); font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        .loose-list { display: flex; flex-direction: column; gap: 5px; }
        .loose-item { background: #222; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; }
        .loose-info { font-size: 0.85rem; color: #ccc; }
        .loose-info span { color: var(--accent-brand); font-weight: bold; }
        .season-charts-grid { display: flex; flex-direction: column; gap: 15px; flex: 1; }
        .season-chart-box { background: #111; border: 1px solid #333; border-radius: 6px; padding: 10px; position: relative; min-height: 250px; flex: 1; }
        .scatter-box { min-height: 400px; } 
        .season-lbl { position: absolute; top: 10px; left: 10px; font-weight: bold; color: #888; font-size: 0.8rem; text-transform: uppercase; }
        .timeline-box-modal { width: 100%; height: 100%; background: #161616; border: 1px solid #333; border-radius: 6px; position: relative; }
        .heatmap-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; height: 100%; }
        .heatmap-box { background: #0f0f13; border: 1px solid #333; border-radius: 6px; flex: 1; min-width: 300px; min-height: 250px; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .hm-title { position: absolute; top: 10px; left: 10px; font-weight: 900; font-size: 1.5rem; opacity: 0.5; z-index: 5; text-transform: uppercase; }
        @media (max-width: 900px) {
            .layout { flex-direction: column; overflow-y: auto; }
            .vis-col { height: auto; min-height: 600px; flex: none; border-right: none; border-bottom: 1px solid var(--border); }
            .data-col { height: auto; flex: 1; overflow: hidden; }
            .radar-grid { grid-template-columns: 1fr; grid-template-rows: auto 400px; }
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="timelineModal">
    <div class="modal-content" style="height: 600px;">
        <div class="modal-header">
            <div class="modal-title">EVOLUCI√ìN DEL PARTIDO (xG TIMELINE)</div>
            <div class="modal-tools">
                <button class="btn-action" onclick="saveCanvas('chartTimeline', 'Evolucion_xG')">üì∑ Guardar Imagen</button>
                <button class="btn-close" onclick="toggleTimeline(false)">Cerrar</button>
            </div>
        </div>
        <div class="timeline-box-modal"><canvas id="chartTimeline"></canvas></div>
    </div>
</div>

<div class="modal-overlay" id="heatmapModal">
    <div class="modal-content" style="max-width: 1100px;">
        <div class="modal-header">
            <div class="modal-title">MAPAS DE CALOR (POSICI√ìN DE TIROS)</div>
            <div class="modal-tools">
                <button class="btn-action" onclick="saveCanvas('hmCanvasPropio', 'Heatmap_Propio')">üì∑ Guardar Propio</button>
                <button class="btn-action" onclick="saveCanvas('hmCanvasRival', 'Heatmap_Rival')">üì∑ Guardar Rival</button>
                <button class="btn-close" onclick="toggleHeatmap(false)">Cerrar</button>
            </div>
        </div>
        <div class="heatmap-container">
            <div class="heatmap-box">
                <div class="hm-title" style="color: var(--accent-blue)">PROPIO</div>
                <canvas id="hmCanvasPropio"></canvas>
            </div>
            <div class="heatmap-box">
                <div class="hm-title" style="color: var(--accent-red)">RIVAL</div>
                <canvas id="hmCanvasRival"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="radarModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">COMPARADOR DE EFICIENCIA (NORMALIZADO p90)</div>
            <div class="modal-tools">
                <button class="btn-action" onclick="saveCanvas('radarCanvas', 'Radar_Comparison')">üì∑ Guardar Imagen</button>
                <button class="btn-close" onclick="toggleRadar(false)">Cerrar</button>
            </div>
        </div>
        <div class="radar-grid">
            <div class="radar-panel">
                <div class="importer-box">
                    <div class="importer-title">Importar Jugador</div>
                    <div style="display:flex; gap:5px;">
                        <select id="radarPlayerSelect" style="flex:1;"><option value="">-- Seleccionar --</option></select>
                        <button onclick="importPlayerToRadar()" style="background:var(--accent-blue); color:#fff; border:none; border-radius:4px; cursor:pointer;">+</button>
                    </div>
                </div>
                <div class="importer-box" style="border-color:#444;">
                    <div class="importer-title">A√±adir Manualmente</div>
                    <div class="player-input-row">
                        <input type="text" id="manualName" placeholder="Nombre">
                        <input type="number" id="manualMin" placeholder="Min" value="90">
                    </div>
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <input type="number" id="manualShots" placeholder="Tiros" step="1">
                        <input type="number" id="manualXG" placeholder="xG" step="0.01">
                        <input type="number" id="manualXGOT" placeholder="xGOT" step="0.01">
                    </div>
                    <button onclick="addManualPlayer()" style="width:100%; background:#444; color:#fff; border:1px solid #666; padding:5px; border-radius:4px; cursor:pointer; font-size:0.7rem; font-weight:bold;">A√ëADIR MANUAL</button>
                </div>
                <hr style="border-color:#333; width:100%;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.75rem; color:#888; font-weight:bold; text-transform:uppercase;">Lista Comparativa</span>
                    <button onclick="clearRadarData()" style="font-size:0.6rem; background:none; border:none; color:#e74c3c; cursor:pointer;">Limpiar</button>
                </div>
                <div class="radar-player-list" id="radarListContainer"></div>
                <div class="importer-box" style="margin-top:auto;">
                   <div class="importer-title">Configuraci√≥n Escala</div>
                   <div style="display:flex; gap:5px;">
                       <div style="flex:1"><span style="font-size:0.6rem; color:#aaa;">Max Tiros</span><input type="number" id="scaleShots" value="6" oninput="drawRadar()"></div>
                       <div style="flex:1"><span style="font-size:0.6rem; color:#aaa;">Max xG</span><input type="number" id="scaleXG" value="1.0" step="0.1" oninput="drawRadar()"></div>
                   </div>
                </div>
            </div>
            <div class="radar-box">
                <canvas id="radarCanvas"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="seasonModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">AN√ÅLISIS DE TEMPORADA</div>
            <div class="modal-tools">
                <button class="btn-action" onclick="downloadSeasonReport()">üì∑ Guardar Imagen</button>
                <button class="btn-delete" onclick="clearSeasonHistory()">üóëÔ∏è Borrar Historial</button>
                <button class="btn-close" onclick="toggleSeasonModal(false)">Cerrar</button>
            </div>
        </div>
        <div class="season-charts-grid">
            <div class="season-chart-box scatter-box">
                <div class="season-lbl">RENDIMIENTO: xG FAVOR (X) vs xG CONTRA (Y)</div>
                <canvas id="chartSeasonScatter"></canvas>
            </div>
            <div style="display:flex; gap:10px; height: 250px; flex-wrap:wrap;">
                <div class="season-chart-box">
                    <div class="season-lbl">OFENSIVA: Goles (Azul) vs xG (Naranja)</div>
                    <canvas id="chartSeasonAtt"></canvas>
                </div>
                <div class="season-chart-box">
                    <div class="season-lbl">DEFENSIVA: Goles C. (Azul) vs xG Rival (Naranja)</div>
                    <canvas id="chartSeasonDef"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="looseModal">
    <div class="modal-content" style="max-width: 600px; height: 70vh;">
        <div class="modal-header">
            <div class="modal-title">ARCHIVO DE PARTIDOS</div>
            <button class="btn-close" onclick="document.getElementById('looseModal').style.display='none'">Cerrar</button>
        </div>
        <div id="looseContainer" class="loose-list"></div>
    </div>
</div>

<header>
    <div class="logo">MATCH <span>DATA HUB v18.11</span></div>
    <div class="header-inputs">
        <input type="text" id="jornadaInput" class="input-jornada" placeholder="Jor">
        <div class="tools">
            <input type="file" id="csvInput" style="display:none;" accept=".csv" onchange="importCSV(this)">
            
            <button onclick="toggleTimeline(true)" class="btn-timeline">üìà Timeline</button>
            <button onclick="toggleHeatmap(true)" class="btn-heat">üî• Mapas Calor</button>
            <button onclick="toggleRadar(true)" class="btn-radar">‚ö° Radar</button>
            <button onclick="toggleSeasonModal(true)" class="btn-season">üìä An√°lisis</button>
            
            <button onclick="saveToSeasonHistory()" class="btn-save-season">Guardar Jornada</button>
            <button onclick="saveLooseMatch()" class="btn-loose">Guardar Suelto</button>
            <button onclick="viewLooseMatches()" style="background:#555">üìÇ Archivo</button>
            
            <button onclick="resetMatch()">Reset</button>
            <button class="btn-excel" onclick="downloadExcel()">CSV</button>
        </div>
    </div>
</header>

<div class="layout">
    <div class="vis-col">
        <div class="metrics-overlay">
            <div class="metric-box">
                <span class="metric-val" style="color:var(--accent-brand);" id="liveXG">0.000</span>
                <span class="metric-lbl">xG</span>
            </div>
            <div class="metric-box" style="border-color: #fff;">
                <span class="metric-val" style="color:#fff;" id="liveXGOT">0.000</span>
                <span class="metric-lbl">xGOT</span>
            </div>
            <div class="metric-box" style="background: rgba(50,50,50,0.9); min-width:auto;">
                 <span class="metric-zone" id="zoneLabel">-</span>
            </div>
        </div>
        
        <div class="pitch-container" id="containerPitch">
            <button class="btn-camera" onclick="saveCanvas('pitchCanvas', 'Mapa_Tiros')" title="Guardar Imagen">üì∑</button>
            <canvas id="pitchCanvas"></canvas>
        </div>
        
        <div class="goal-container" id="containerGoal">
            <div class="chart-title-overlay">PORTER√çA</div>
            <canvas id="goalCanvas"></canvas>
        </div>
    </div>

    <div class="data-col">
        <div class="scoreboard">
            <div class="sb-team"><span class="sb-name ts-home">PROPIO</span><div class="sb-score ts-home" id="scoreHomeGoals">0</div></div>
            <div class="sb-div">VS</div>
            <div class="sb-team"><span class="sb-name ts-away">RIVAL</span><div class="sb-score ts-away" id="scoreAwayGoals">0</div></div>
        </div>

        <div class="charts-wrapper">
            <div class="chart-container"><div class="chart-title">EFICIENCIA xG</div><canvas id="chartXG"></canvas></div>
            <div class="chart-container"><div class="chart-title">EFICIENCIA xGOT</div><canvas id="chartXGOT"></canvas></div>
        </div>

        <div class="controls-area">
            <div class="ctrl-group">
                <div class="ctrl-header"><span>1. Datos Evento</span></div>
                <div class="row">
                    <div style="flex:1">
                        <label class="slider-lbl">Tiempo (Min : Seg)</label>
                        <div class="time-input-group">
                            <input type="number" id="matchMinute" value="0" placeholder="00" min="0" max="130">
                            <span style="color:#666; font-weight:bold;">:</span>
                            <input type="number" id="matchSeconds" value="0" placeholder="00" min="0" max="59">
                        </div>
                    </div>
                    <div style="flex:1"><label class="slider-lbl">Resultado</label><select id="realOutcome" style="background:#333; font-weight:bold;"><option value="Gol">‚öΩ GOL</option><option value="Parada">üß§ PARADA</option><option value="Poste">ü•Ö POSTE</option><option value="Bloqueado">üõ°Ô∏è BLOQUEADO</option><option value="Fuera">‚ùå FUERA</option></select></div>
                </div>
                <div class="player-input-row">
                    <input type="text" id="playerName" placeholder="Nombre Jugador">
                    <input type="number" id="playerDorsal" placeholder="#" title="Dorsal">
                </div>
            </div>

            <div class="ctrl-group">
                <div class="ctrl-header"><span>2. Trayectoria (Auto)</span> <span id="lblDist" style="color:#fff"></span></div>
                <div class="row" style="opacity: 0.6;">
                   <div style="flex:1"><label class="slider-lbl">X</label><input type="number" id="posX" step="0.5" value="103.5" readonly></div>
                   <div style="flex:1"><label class="slider-lbl">Y</label><input type="number" id="posY" step="0.5" value="40" readonly></div>
                </div>
                <input type="hidden" id="endY" value="38">
                <input type="hidden" id="endZ" value="1.2">
            </div>

            <div class="ctrl-group">
                <div class="ctrl-header"><span>3. Contexto</span></div>
                <div class="row"><select id="tipoJugada"><option value="abierto">Juego Abierto</option><option value="falta">Falta</option><option value="penalti">Penalti</option><option value="corner">C√≥rner</option></select><select id="parteCuerpo"><option value="pie">Pie</option><option value="cabeza">Cabeza</option></select></div>
                <select id="portero"><option value="colocado">Portero Colocado</option><option value="descolocado">Batido / Puerta Vac√≠a</option></select>
            </div>

            <div class="btns-row"><button class="btn-act btn-home" onclick="addShot('Propio')">PROPIO <span class="btn-badge" id="badgeHome">0</span></button><button class="btn-act btn-away" onclick="addShot('Rival')">RIVAL <span class="btn-badge" id="badgeAway">0</span></button></div>
        </div>

        <div class="log-area">
            <table><thead><tr><th width="10%">Act</th><th width="10%">T</th><th width="15%">Jugador</th><th width="10%">Eq</th><th>Res</th><th>xG</th><th>xGOT</th></tr></thead><tbody id="logBody"></tbody></table>
        </div>
    </div>
</div>

<script>
    let matchData = { jornada: "", shots: [], stats: { Propio: {xg:0, xgot:0, goals:0, count:0}, Rival: {xg:0, xgot:0, goals:0, count:0} } };
    let seasonHistory = [];
    let archiveHistory = [];
    let radarDatasets = [];
    let radarColors = ['#3498db', '#e74c3c', '#f1c40f', '#9b59b6', '#2ecc71', '#1abc9c', '#e67e22'];
    let clickPhase = 0; 
    let gkPosition = { x: 118, y: 40 };
    let mousePos = null; 

    const inputs = { 
        jornada: document.getElementById('jornadaInput'), 
        min: document.getElementById('matchMinute'),
        sec: document.getElementById('matchSeconds'), 
        outcome: document.getElementById('realOutcome'), 
        playerName: document.getElementById('playerName'),
        playerDorsal: document.getElementById('playerDorsal'),
        tipo: document.getElementById('tipoJugada'), 
        cuerpo: document.getElementById('parteCuerpo'), 
        portero: document.getElementById('portero'), 
        posX: document.getElementById('posX'), 
        posY: document.getElementById('posY'), 
        endY: document.getElementById('endY'), 
        endZ: document.getElementById('endZ') 
    };

    const ui = { 
        liveXG: document.getElementById('liveXG'), 
        liveXGOT: document.getElementById('liveXGOT'), 
        goalsHome: document.getElementById('scoreHomeGoals'), 
        goalsAway: document.getElementById('scoreAwayGoals'), 
        badgeHome: document.getElementById('badgeHome'), 
        badgeAway: document.getElementById('badgeAway'), 
        log: document.getElementById('logBody'), 
        dist: document.getElementById('lblDist'), 
        zone: document.getElementById('zoneLabel') 
    };

    const LOGICAL_W = 80; const LOGICAL_H = 37; const VIEW_START_X = 85; const DATA_X_END = 122;

    function loadData() { 
        const d = localStorage.getItem('matchHub_v18'); 
        if(d) { try { matchData = JSON.parse(d); if(matchData.jornada) inputs.jornada.value = matchData.jornada; updateUI(); } catch(e){} } 
        const s = localStorage.getItem('seasonHistory_v1'); if(s) try { seasonHistory = JSON.parse(s); } catch(e){}
        const a = localStorage.getItem('archiveHistory_v1'); if(a) try { archiveHistory = JSON.parse(a); } catch(e){}
        updateRadarPlayerSelect();
    }
    function saveData() { matchData.jornada = inputs.jornada.value; localStorage.setItem('matchHub_v18', JSON.stringify(matchData)); }

    function toggleTimeline(show) { document.getElementById('timelineModal').style.display = show ? 'flex' : 'none'; if(show) setTimeout(() => drawTimeline(), 100); }

    // --- DRAW PITCH (WITH TOOLTIP) ---
    function drawPitch(d) {
        const cv = document.getElementById('pitchCanvas');
        const ctx = cv.getContext('2d');
        const cnt = document.getElementById('containerPitch');
        
        let w = cnt.clientWidth; let h = cnt.clientHeight;
        if(w === 0 || h === 0) { w = 300; h = 400; } 

        cv.width = w; cv.height = h;

        let scaleX = w / LOGICAL_W; let scaleY = h / LOGICAL_H; let scale = Math.min(scaleX, scaleY);
        let drawW = LOGICAL_W * scale; let drawH = LOGICAL_H * scale; let offX = (w - drawW) / 2; let offY = (h - drawH) / 2;
        const toC = (dx, dy) => ({ x: offX + (dy * scale), y: offY + ((DATA_X_END - dx) * scale) });

        ctx.fillStyle = "#1e272e"; ctx.fillRect(0,0,w,h);
        ctx.fillStyle = "#437c35"; ctx.fillRect(offX, offY, drawW, drawH); 

        ctx.fillStyle = "#3c6e2f";
        for(let i=85; i<=125; i+=5.5) { if (Math.floor((i-85)/5.5) % 2 !== 0) { let yTop = toC(Math.min(i+5.5, 122), 0).y; let yBot = toC(i, 0).y; ctx.fillRect(offX, yTop, drawW, yBot - yTop); } }
        ctx.strokeStyle = "rgba(255,255,255,0.8)"; ctx.lineWidth = 2; ctx.lineCap = "round"; ctx.strokeRect(offX, offY, drawW, drawH);

        let boxTL = toC(120, 19.84); let boxBR = toC(103.5, 60.16);
        ctx.beginPath(); ctx.rect(boxTL.x, boxTL.y, (toC(120, 60.16).x - boxTL.x), (boxBR.y - boxTL.y)); ctx.stroke();
        let smTL = toC(120, 30.84); let smBR = toC(114.5, 49.16);
        ctx.beginPath(); ctx.rect(smTL.x, smTL.y, (toC(120, 49.16).x - smTL.x), (smBR.y - smTL.y)); ctx.stroke();
        let pen = toC(109, 40); ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(pen.x, pen.y, 3, 0, Math.PI*2); ctx.fill();

        let alpha = Math.asin(5.5/9.15); 
        ctx.beginPath(); ctx.arc(pen.x, pen.y, 9.15*scale, alpha, Math.PI - alpha); ctx.stroke();

        let pL = toC(120, 36.34); let pR = toC(120, 43.66); let pL_back = toC(122, 36.34); let pR_back = toC(122, 43.66);
        ctx.beginPath(); ctx.moveTo(pL.x, pL.y); ctx.lineTo(pL_back.x, pL_back.y); ctx.lineTo(pR_back.x, pR_back.y); ctx.lineTo(pR.x, pR.y);
        ctx.lineWidth=1; ctx.strokeStyle="rgba(255,255,255,0.5)"; ctx.stroke();

        matchData.shots.forEach(s => {
            let p = toC(s.startX, s.startY);
            ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2);
            ctx.fillStyle = s.team === 'Propio' ? '#3498db' : '#e74c3c';
            ctx.strokeStyle = "#fff"; ctx.lineWidth = 1;
            ctx.fill(); ctx.stroke();
        });

        // --- TOOLTIP LOGIC ---
        if (mousePos) {
            matchData.shots.forEach(s => {
                let p = toC(s.startX, s.startY);
                let dist = Math.sqrt( (mousePos.x - p.x)**2 + (mousePos.y - p.y)**2 );

                if (dist < 10) {
                    let boxX = p.x + 10;
                    let boxY = p.y - 35;
                    if (boxX + 120 > w) boxX = p.x - 130;
                    if (boxY < 0) boxY = p.y + 10;

                    ctx.fillStyle = "rgba(0, 0, 0, 0.9)";
                    ctx.fillRect(boxX, boxY, 110, 40);
                    ctx.strokeStyle = s.team === 'Propio' ? '#3498db' : '#e74c3c';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(boxX, boxY, 110, 40);

                    ctx.fillStyle = "#fff";
                    ctx.font = "bold 11px sans-serif";
                    ctx.textAlign = "left";
                    ctx.fillText(`xG: ${s.xg.toFixed(2)}`, boxX + 10, boxY + 15);
                    ctx.fillText(`xGOT: ${s.xgot.toFixed(2)}`, boxX + 10, boxY + 30);
                }
            });
        }

        if(d && d.startX) {
            let targetVisualX = (d.startX < 60) ? 0 : 120;
            let origin = toC(d.startX, d.startY); 
            let dest = toC(targetVisualX, parseFloat(inputs.endY.value));
            
            ctx.beginPath(); ctx.moveTo(origin.x, origin.y); ctx.lineTo(dest.x, dest.y);
            ctx.strokeStyle="rgba(255, 235, 59, 0.6)"; ctx.lineWidth=2; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
            ctx.beginPath(); ctx.arc(origin.x, origin.y, 6, 0, Math.PI*2); ctx.fillStyle = clickPhase === 0 ? "#f1c40f" : "rgba(241, 196, 15, 0.5)"; ctx.fill(); ctx.stroke();
        }
        let gk = toC(gkPosition.x, gkPosition.y);
        ctx.save(); ctx.translate(gk.x, gk.y); ctx.beginPath(); ctx.moveTo(0, 5); ctx.lineTo(-5, -5); ctx.lineTo(5, -5); ctx.closePath(); ctx.fillStyle = "#3498db"; ctx.fill(); ctx.restore();
    }

    const pCanvas = document.getElementById('pitchCanvas');
    pCanvas.addEventListener('mousedown', handlePitchClick);
    pCanvas.addEventListener('touchstart', handlePitchClick, {passive:false});
    
    // Mouse Tracking
    pCanvas.addEventListener('mousemove', (e) => {
        const rect = pCanvas.getBoundingClientRect();
        mousePos = {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
        draw();
    });
    pCanvas.addEventListener('mouseleave', () => {
        mousePos = null;
        draw();
    });

    function handlePitchClick(e) {
        e.preventDefault(); const rect = pCanvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const w = pCanvas.width; const h = pCanvas.height;
        let scaleX = w / LOGICAL_W; let scaleY = h / LOGICAL_H; let scale = Math.min(scaleX, scaleY);
        let drawW = LOGICAL_W * scale; let drawH = LOGICAL_H * scale; let offX = (w - drawW) / 2; let offY = (h - drawH) / 2;
        let clickX = clientX - rect.left; let clickY = clientY - rect.top;
        let gameY = (clickX - offX) / scale; let gameX = 122 - ((clickY - offY) / scale);
        
        gameY = Math.max(0, Math.min(80, gameY)); 
        gameX = Math.max(0, Math.min(120, gameX)); 

        if(clickPhase === 0) { inputs.posX.value = gameX.toFixed(1); inputs.posY.value = gameY.toFixed(1); clickPhase = 1; } 
        else { gkPosition.x = gameX; gkPosition.y = gameY; clickPhase = 0; }
        draw();
    }

    // --- DRAW GOAL ---
    function drawGoal(d) {
        const cv=document.getElementById('goalCanvas'), ctx=cv.getContext('2d'), cnt=document.getElementById('containerGoal');
        let w = cnt.clientWidth; let h = cnt.clientHeight;
        if(w === 0 || h === 0) { w = 240; h = 180; } 

        cv.width = w; cv.height = h;
        const sx=w/18, sz=h/5; const toG=(y,z)=>({x:(w/2)+((y-40)*sx),y:h-((z+0.5)*sz)});
        
        ctx.fillStyle = "#dfe6e9"; ctx.fillRect(0,0,w,h); 
        ctx.fillStyle="#27ae60"; ctx.fillRect(0,h-(0.5*sz),w,0.5*sz); 
        
        let bl=toG(36,0),tl=toG(36,2.44),tr=toG(44,2.44),br=toG(44,0);
        ctx.fillStyle = "rgba(255,255,255,0.4)"; ctx.beginPath(); ctx.moveTo(bl.x,bl.y); ctx.lineTo(tl.x,tl.y); ctx.lineTo(tr.x,tr.y); ctx.lineTo(br.x,br.y); ctx.fill();
        ctx.strokeStyle="rgba(0,0,0,0.1)"; ctx.lineWidth=1; 
        ctx.beginPath(); for(let x=bl.x; x<=br.x; x+=10) { ctx.moveTo(x, tl.y); ctx.lineTo(x, bl.y); } for(let y=tl.y; y<=bl.y; y+=10) { ctx.moveTo(bl.x, y); ctx.lineTo(br.x, y); } ctx.stroke();

        ctx.strokeStyle="#ffffff"; ctx.lineWidth=6; ctx.lineCap="round"; ctx.lineJoin="round";
        ctx.beginPath(); ctx.moveTo(bl.x,bl.y); ctx.lineTo(tl.x,tl.y); ctx.lineTo(tr.x,tr.y); ctx.lineTo(br.x,br.y); ctx.stroke();
        ctx.strokeStyle="rgba(0,0,0,0.2)"; ctx.lineWidth=2; 
        ctx.beginPath(); ctx.moveTo(bl.x+2,bl.y); ctx.lineTo(tl.x+2,tl.y+2); ctx.lineTo(tr.x-2,tr.y+2); ctx.lineTo(br.x-2,br.y); ctx.stroke();

        if(inputs.portero.value==='colocado'){ let gk=toG(40,1.0); ctx.beginPath();ctx.arc(gk.x,gk.y,20,0,Math.PI*2); ctx.fillStyle="rgba(52,152,219,0.3)";ctx.fill();ctx.stroke(); }

        let ball=toG(parseFloat(inputs.endY.value),parseFloat(inputs.endZ.value));
        ctx.beginPath(); 
        if(d.tray.includes("GOL")){ctx.strokeStyle="#fff";ctx.fillStyle="rgba(52,152,219,0.9)";} else{ctx.strokeStyle="#fff";ctx.fillStyle="rgba(231,76,60,0.9)";}
        ctx.arc(ball.x,ball.y,12,0,Math.PI*2); ctx.fill(); ctx.lineWidth=3; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(ball.x-18,ball.y); ctx.lineTo(ball.x+18,ball.y); ctx.moveTo(ball.x,ball.y-18); ctx.lineTo(ball.x,ball.y+18); ctx.stroke();
        ctx.fillStyle = "#333"; ctx.font = "bold 12px sans-serif"; ctx.textAlign = "right"; ctx.fillText("3. CLICK DESTINO", w-10, 20);
    }
    const gCanvas = document.getElementById('goalCanvas');
    gCanvas.addEventListener('mousedown', handleGoalInteract); 
    gCanvas.addEventListener('touchstart', handleGoalInteract, {passive: false});
    function handleGoalInteract(e) {
        e.preventDefault(); const rect = gCanvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const x = clientX - rect.left; const y = clientY - rect.top;
        const sx = gCanvas.width / 18; const sz = gCanvas.height / 5;
        let goalY = ((x - (gCanvas.width/2)) / sx) + 40; let goalZ = ((gCanvas.height - y) / sz) - 0.5;
        goalY = Math.max(30, Math.min(50, goalY)); goalZ = Math.max(0, Math.min(4, goalZ)); 
        inputs.endY.value = goalY.toFixed(2); inputs.endZ.value = goalZ.toFixed(2);
        const isGoal = (goalY >= 36 && goalY <= 44) && (goalZ >= 0 && goalZ <= 2.44); inputs.outcome.value = isGoal ? "Gol" : "Fuera";
        draw();
    }

    function interpolate(dist, points) { for (let i = 0; i < points.length - 1; i++) { let p1 = points[i]; let p2 = points[i+1]; if (dist >= p1.d && dist <= p2.d) { let t = (dist - p1.d) / (p2.d - p1.d); return p1.v + t * (p2.v - p1.v); } } return points[points.length-1].v; }
    
    // --- FUNCTION CALCULATE (NEW FINE-TUNED CALIBRATION) ---
    function calculate() {
        let startX = parseFloat(inputs.posX.value);
        let startY = parseFloat(inputs.posY.value);
        let endY = parseFloat(inputs.endY.value);
        let endZ = parseFloat(inputs.endZ.value);

        let targetX = 120;
        if (startX < 60) targetX = 0; 
        
        if(inputs.tipo.value === 'penalti') { 
            startX = (targetX === 0) ? 12 : 108; 
            startY = 40; 
        }

        const distX = Math.abs(targetX - startX); 
        const distY = Math.abs(40 - startY); 
        const dist = Math.sqrt(distX*distX + distY*distY); 
        ui.dist.innerText = `${dist.toFixed(1)}m`;

        const distCurve = [{d: 0, v: 0.95}, {d: 5, v: 0.50}, {d: 11, v: 0.17}, {d: 16.5, v: 0.09}, {d: 20, v: 0.05}, {d: 25, v: 0.03}, {d: 35, v: 0.01}];
        let baseXG = interpolate(dist, distCurve);
        const angle = Math.atan(7.32 * distX / (distX*distX + distY*distY - 26.79)); 
        let angleVal = isNaN(angle) || angle < 0 ? 0 : angle;
        let angleFactor = Math.min(angleVal * 3.0, 1.0); 
        if(dist < 5) angleFactor = Math.max(angleFactor, 0.7); 
        let xg = baseXG * angleFactor;
        
        let zona = ""; if (dist < 7.5) zona = "AREA PEQ"; else if (dist < 13) zona = "PENALTI"; else if (dist < 18) zona = "FRONTAL"; else if (dist < 24) zona = "SEMICIRC"; else zona = "LEJOS";
        if(distY > 15) zona = "LATERAL"; ui.zone.innerText = zona;
        let modifier = 1.0; if (inputs.cuerpo.value === 'cabeza') modifier *= 0.60; if (inputs.tipo.value === 'falta') modifier *= 0.85; if (inputs.tipo.value === 'corner') modifier *= 0.80;
        if (inputs.tipo.value === 'penalti') { xg = 0.78; } if (inputs.portero.value === 'descolocado') { xg = Math.max(xg, 0.85); } else { xg = xg * modifier; }
        
        // --- CALIBRACI√ìN FINA (V18.11) ---
        const isGoal = (endY >= 36 && endY <= 44) && (endZ >= 0 && endZ <= 2.44);
        let xgot = 0.0; 
        let tray = "FUERA";

        if (isGoal || inputs.outcome.value === 'Parada') {
            tray = isGoal ? "A PUERTA" : "A PUERTA (PARADA)";
            if (inputs.portero.value === 'descolocado') { 
                xgot = 0.96; 
            } else {
                // Factor X: 0 es centro, 1 es poste (4m)
                let xFactor = Math.abs(endY - 40) / 4.0;
                // Factor Z: 0 es suelo, 1 es larguero (2.44m)
                let zFactor = endZ / 2.44; 

                // Clamp
                xFactor = Math.min(Math.max(xFactor, 0), 1.0);
                zFactor = Math.min(Math.max(zFactor, 0), 1.0);

                // --- NUEVA F√ìRMULA CUADR√ÅTICA/EXPONENCIAL ---
                // Base: 0.12
                // Horizontal Growth (Power 1.5): 0.35 * x^1.5
                //   -> x=0 => 0 (Total 0.12)
                //   -> x=0.5 => 0.12 (Total 0.24) [MATCHES MID-LOW 0.24]
                //   -> x=1 => 0.35 (Total 0.47) [MATCHES POST-LOW 0.47]
                let hTerm = 0.35 * Math.pow(xFactor, 1.5);

                // Vertical Multiplier (Quadratic Curve): 0.3*x^2 - 0.21*x + 0.07
                //   -> x=0 (Center) => 0.07. Total High: 0.12 + 0.07 = 0.19 [MATCHES CENTER-HIGH]
                //   -> x=0.5 (Mid) => 0.04. Total High: 0.24 + 0.04 = 0.28 [MATCHES MID-HIGH]
                //   -> x=1 (Post) => 0.16. Total High: 0.47 + 0.16 = 0.63 [MATCHES TOP-CORNER]
                let vMult = (0.3 * (xFactor * xFactor)) - (0.21 * xFactor) + 0.07;

                let xgotCalc = 0.12 + hTerm + (vMult * zFactor);

                if(inputs.cuerpo.value === 'cabeza') xgotCalc *= 0.85;
                xgot = xgotCalc;
            }
        } 
        
        return { xg, xgot, tray, startX, startY };
    }

    function addShot(team) {
        const c = calculate(); const res = inputs.outcome.value;
        let finalXgot = c.xgot; if (res === 'Poste' || res === 'Bloqueado' || res === 'Fuera') finalXgot = 0.0;
        const m = parseInt(inputs.min.value) || 0;
        const s = parseInt(inputs.sec.value) || 0;
        const timeFloat = m + (s/60);
        const timeStr = `${m}:${s < 10 ? '0'+s : s}`;

        const shot = { 
            id: Date.now(), minute: m, second: s, timeFloat: timeFloat, timeStr: timeStr,
            team: team, type: inputs.tipo.value, result: res, 
            player: inputs.playerName.value, dorsal: inputs.playerDorsal.value,
            xg: c.xg, xgot: finalXgot, startX: c.startX, startY: c.startY, endY: parseFloat(inputs.endY.value), 
            endZ: parseFloat(inputs.endZ.value), gkX: gkPosition.x, gkY: gkPosition.y  
        };
        matchData.shots.push(shot); recalc(); saveData(); updateUI(); updateRadarPlayerSelect(); clickPhase = 0; draw();
    }
    window.deleteShot = function(id) { if(confirm("¬øEliminar tiro?")) { matchData.shots = matchData.shots.filter(s => s.id !== id); recalc(); saveData(); updateUI(); updateRadarPlayerSelect(); } };
    
    window.editShotPlayer = function(id) {
        const shot = matchData.shots.find(s => s.id === id);
        if (!shot) return;
        const newName = prompt("Editar nombre del jugador:", shot.player);
        if (newName !== null) {
            shot.player = newName;
            const newDorsal = prompt("Editar dorsal:", shot.dorsal);
            if(newDorsal !== null) shot.dorsal = newDorsal;
            saveData();
            updateUI();
            updateRadarPlayerSelect(); 
        }
    };

    function recalc() { matchData.stats = { Propio: {xg:0, xgot:0, goals:0, count:0}, Rival: {xg:0, xgot:0, goals:0, count:0} }; matchData.shots.forEach(s => { matchData.stats[s.team].xg += s.xg; matchData.stats[s.team].xgot += s.xgot; matchData.stats[s.team].count++; if(s.result === 'Gol') matchData.stats[s.team].goals++; }); }
    
    function updateUI() {
        ui.goalsHome.innerText = matchData.stats.Propio.goals; ui.goalsAway.innerText = matchData.stats.Rival.goals;
        ui.badgeHome.innerText = matchData.stats.Propio.count; ui.badgeAway.innerText = matchData.stats.Rival.count;
        ui.log.innerHTML = '';
        [...matchData.shots].sort((a,b) => b.timeFloat - a.timeFloat).forEach(s => {
            const tr = document.createElement('tr');
            let color = '#fff'; if(s.result==='Gol') color='#2ecc71'; else if(s.result==='Fuera') color='#e74c3c'; else if(s.result==='Parada') color='#f1c40f';
            tr.innerHTML = `<td>
                <button class="btn-del-row" onclick="deleteShot(${s.id})">√ó</button>
                <button class="btn-edit-row" onclick="editShotPlayer(${s.id})" title="Editar Jugador">‚úé</button>
            </td>
            <td>${s.timeStr}</td><td>${s.player||""} <span style="font-size:0.8em;color:#888">#${s.dorsal||""}</span></td><td style="font-weight:bold; color:${s.team==='Propio'?'var(--accent-blue)':'var(--accent-red)'}">${s.team.charAt(0)}</td><td style="color:${color}">${s.result}</td><td>${s.xg.toFixed(2)}</td><td>${s.xgot.toFixed(2)}</td>`;
            ui.log.appendChild(tr);
        });
        drawBarChart('chartXG', matchData.stats.Propio.xg, matchData.stats.Propio.goals, matchData.stats.Rival.xg, matchData.stats.Rival.goals);
        drawBarChart('chartXGOT', matchData.stats.Propio.xgot, matchData.stats.Propio.goals, matchData.stats.Rival.xgot, matchData.stats.Rival.goals);
    }
    
    function drawBarChart(cid, pM, pG, rM, rG) {
        const cv = document.getElementById(cid); if(!cv || !cv.parentElement) return; cv.width = cv.parentElement.clientWidth; cv.height = cv.parentElement.clientHeight;
        const ctx=cv.getContext('2d'), w=cv.width, h=cv.height, max=Math.max(pM,pG,rM,rG,1)*1.2, bw=15, cx=w/2, gap=20, fl=h-5;
        ctx.clearRect(0,0,w,h);
        const dB = (x,v,c,o) => {
            const bh=(v/max)*(h-15), y=fl-bh; ctx.fillStyle=c; ctx.strokeStyle=c; ctx.lineWidth=2;
            if(o){ctx.strokeRect(x,y,bw,bh);ctx.globalAlpha=0.2;ctx.fillRect(x,y,bw,bh);ctx.globalAlpha=1;} else {ctx.fillRect(x,y,bw,bh);}
            ctx.fillStyle="#fff"; ctx.font="9px Arial"; ctx.textAlign="center"; ctx.fillText(v.toFixed(3),x+bw/2,y-3);
        };
        dB(cx-gap-bw*2-5,pM,"#3498db",true); dB(cx-gap-bw,pG,"#3498db",false); dB(cx+gap,rG,"#e74c3c",false); dB(cx+gap+bw+5,rM,"#e74c3c",true);
    }
    
    function drawTimeline() {
        const cv=document.getElementById('chartTimeline'), ctx=cv.getContext('2d'), cnt=document.getElementById('timelineModal').querySelector('.timeline-box-modal');
        if(!cnt || !cnt.clientWidth) return; cv.width=cnt.clientWidth; cv.height=cnt.clientHeight;
        const w=cv.width, h=cv.height; ctx.clearRect(0,0,w,h);
        const padL = 30, padB = 20; const graphW = w - padL - 10; const graphH = h - padB - 10;
        const maxTime = 100; let maxXG = Math.max(matchData.stats.Propio.xg, matchData.stats.Rival.xg, 0.5); maxXG = Math.ceil(maxXG * 5) / 5;
        ctx.textAlign = "center"; ctx.font="9px monospace";
        for(let t=0; t<=maxTime; t+=5) {
            let x = padL + (t/maxTime)*graphW;
            ctx.strokeStyle = (t%15===0) ? "rgba(255,255,255,0.2)" : "rgba(255,255,255,0.05)";
            ctx.beginPath(); ctx.moveTo(x, 10); ctx.lineTo(x, h-padB); ctx.stroke();
            if(t%5===0) { ctx.fillStyle="#888"; ctx.fillText(t+"'", x, h-5); }
        }
        ctx.textAlign = "right";
        for(let v=0; v<=maxXG; v+=0.2) {
            let y = (h-padB) - (v/maxXG)*graphH;
            ctx.strokeStyle = "rgba(255,255,255,0.1)";
            ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(w, y); ctx.stroke();
            ctx.fillStyle="#888"; ctx.fillText(v.toFixed(1), padL-5, y+3);
        }
        const dL=(tm,cl,fillCl)=>{
            const sh=matchData.shots.filter(s=>s.team===tm).sort((a,b)=>a.timeFloat-b.timeFloat);
            ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle=cl; let cx=0; ctx.moveTo(padL, h-padB);
            sh.forEach(s=>{ let x = padL + (s.timeFloat/maxTime)*graphW; let yp = (h-padB) - (cx/maxXG)*graphH; cx += s.xg; let yn = (h-padB) - (cx/maxXG)*graphH; ctx.lineTo(x,yp); ctx.lineTo(x,yn); });
            ctx.lineTo(padL+graphW, (h-padB)-(cx/maxXG)*graphH); ctx.stroke(); ctx.lineTo(padL+graphW, h-padB); ctx.lineTo(padL, h-padB); ctx.fillStyle = fillCl; ctx.fill();
            cx=0; sh.forEach(s=>{ cx+=s.xg; if(s.result==='Gol'){ let x = padL + (s.timeFloat/maxTime)*graphW; let y = (h-padB) - (cx/maxXG)*graphH; ctx.beginPath(); ctx.fillStyle="#fff"; ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); ctx.stroke(); } });
        };
        dL('Propio', '#3498db', 'rgba(52, 152, 219, 0.2)'); dL('Rival', '#e74c3c', 'rgba(231, 76, 60, 0.2)');
    }

    // --- HEATMAPS ---
    function toggleHeatmap(show) {
        document.getElementById('heatmapModal').style.display = show ? 'flex' : 'none';
        if(show) { setTimeout(() => { drawHeatmap('hmCanvasPropio', 'Propio'); drawHeatmap('hmCanvasRival', 'Rival'); }, 100); }
    }
    function drawHeatmap(canvasId, teamName) {
        const cv = document.getElementById(canvasId); if(!cv.parentElement) return;
        cv.width = cv.parentElement.clientWidth; cv.height = cv.parentElement.clientHeight;
        const ctx = cv.getContext('2d'); const w = cv.width, h = cv.height;

        ctx.fillStyle = "#1e272e"; ctx.fillRect(0,0,w,h);
        ctx.strokeStyle = "rgba(255,255,255,0.2)"; ctx.lineWidth = 2;
        const scaleX = w / 120; const scaleY = h / 80;
        
        // Campo completo
        ctx.strokeRect(0,0,w,h); 
        // L√≠nea de medio campo
        ctx.beginPath(); ctx.moveTo(w/2, 0); ctx.lineTo(w/2, h); ctx.stroke();
        // C√≠rculo central
        ctx.beginPath(); ctx.arc(w/2, h/2, 9.15*scaleX, 0, Math.PI*2); ctx.stroke();
        
        // Funci√≥n para dibujar las √°reas con semic√≠rculos
        const drawArea = (isLeft) => { 
            const dir = isLeft ? 1 : -1; 
            const xG = isLeft ? 0 : w; 
            const xBox = xG + (16.5 * scaleX * dir); 
            const xSmallBox = xG + (5.5 * scaleX * dir);
            const yTop = (40 - 20.16) * scaleY; 
            const yBot = (40 + 20.16) * scaleY;
            const yTopSmall = (40 - 9.16) * scaleY;
            const yBotSmall = (40 + 9.16) * scaleY;
            const yCenterArea = (40) * scaleY;
            const xPenalty = xG + (11 * scaleX * dir);
            
            // √Årea grande
            ctx.beginPath(); 
            ctx.moveTo(xG, yTop); 
            ctx.lineTo(xBox, yTop); 
            ctx.lineTo(xBox, yBot); 
            ctx.lineTo(xG, yBot); 
            ctx.stroke();
            
            // Semic√≠rculo del √°rea grande (9.15 metros desde el punto de penalti)
            let alphaBox = Math.asin(5.5 / 9.15);
            ctx.beginPath();
            if (isLeft) {
                ctx.arc(xPenalty, yCenterArea, 9.15 * scaleX, Math.PI - alphaBox, Math.PI + alphaBox);
            } else {
                ctx.arc(xPenalty, yCenterArea, 9.15 * scaleX, -alphaBox, alphaBox);
            }
            ctx.stroke();
            
            // √Årea peque√±a
            ctx.beginPath();
            ctx.moveTo(xG, yTopSmall);
            ctx.lineTo(xSmallBox, yTopSmall);
            ctx.lineTo(xSmallBox, yBotSmall);
            ctx.lineTo(xG, yBotSmall);
            ctx.stroke();
            
            // Punto de penalti
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.beginPath();
            ctx.arc(xPenalty, yCenterArea, 2, 0, Math.PI*2);
            ctx.fill();
        };
        drawArea(true); drawArea(false);

        ctx.globalCompositeOperation = 'lighter'; 
        const shots = matchData.shots.filter(s => s.team === teamName);
        shots.forEach(s => {
            let x = s.startX * scaleX; let y = s.startY * scaleY;
            let radius = 15 * scaleX; 
            let grd = ctx.createRadialGradient(x, y, 1, x, y, radius);
            grd.addColorStop(0, "rgba(255, 255, 200, 0.6)"); grd.addColorStop(0.4, "rgba(255, 100, 50, 0.3)"); grd.addColorStop(1, "rgba(255, 0, 0, 0)"); 
            ctx.fillStyle = grd; ctx.beginPath(); ctx.arc(x, y, radius, 0, Math.PI*2); ctx.fill();
        });
        ctx.globalCompositeOperation = 'source-over';
    }

    // --- RADAR & SEASON ---
    function toggleRadar(show) { document.getElementById('radarModal').style.display = show ? 'flex' : 'none'; if(show) { updateRadarPlayerSelect(); setTimeout(drawRadar, 100); } }
    function updateRadarPlayerSelect() { const select = document.getElementById('radarPlayerSelect'); select.innerHTML = '<option value="">-- Seleccionar --</option>'; const players = {}; matchData.shots.forEach(s => { const key = s.player || "Anonimo"; if(!players[key]) players[key] = { count: 0 }; players[key].count++; }); Object.keys(players).forEach(pName => { const opt = document.createElement('option'); opt.value = pName; opt.innerText = `${pName} (${players[pName].count} tiros)`; select.appendChild(opt); }); }
    function importPlayerToRadar() { const pName = document.getElementById('radarPlayerSelect').value; if(!pName) return; let shots=0, xg=0, xgot=0; matchData.shots.forEach(s => { if((s.player || "Anonimo") === pName) { shots++; xg += s.xg; xgot += s.xgot; } }); let mins = prompt(`Minutos jugados por ${pName}?`, "90"); if(mins === null) return; mins = parseInt(mins) || 90; addRadarDataset(pName, mins, shots, xg, xgot); }
    function addManualPlayer() { const name = document.getElementById('manualName').value || "Jugador"; const min = parseFloat(document.getElementById('manualMin').value) || 90; const sh = parseFloat(document.getElementById('manualShots').value) || 0; const xg = parseFloat(document.getElementById('manualXG').value) || 0; const xgot = parseFloat(document.getElementById('manualXGOT').value) || 0; addRadarDataset(name, min, sh, xg, xgot); }
    function addRadarDataset(name, minutes, shots, xg, xgot) { const p90Factor = minutes > 0 ? 90 / minutes : 0; const stats = { shots90: shots * p90Factor, xg90: xg * p90Factor, xgot90: xgot * p90Factor }; const color = radarColors[radarDatasets.length % radarColors.length]; radarDatasets.push({ name, minutes, raw:{shots, xg, xgot}, stats, color }); renderRadarList(); drawRadar(); }
    function removeRadarDataset(index) { radarDatasets.splice(index, 1); renderRadarList(); drawRadar(); }
    function clearRadarData() { radarDatasets = []; renderRadarList(); drawRadar(); }
    function renderRadarList() { const c = document.getElementById('radarListContainer'); c.innerHTML = ""; radarDatasets.forEach((d, i) => { const div = document.createElement('div'); div.className = 'rp-card'; div.style.borderLeftColor = d.color; div.innerHTML = `<div class="rp-header"><span class="rp-name" style="color:${d.color}">${d.name} <span style="color:#666; font-size:0.7em;">(${d.minutes} min)</span></span><button class="rp-remove" onclick="removeRadarDataset(${i})">√ó</button></div><div class="rp-stats"><span>Shots: <strong>${d.stats.shots90.toFixed(2)}</strong></span><span>xG: <strong>${d.stats.xg90.toFixed(2)}</strong></span><span>xGOT: <strong>${d.stats.xgot90.toFixed(2)}</strong></span></div>`; c.appendChild(div); }); }
    function drawRadar() { 
        const cv = document.getElementById('radarCanvas'); if(!cv.parentElement) return; 
        cv.width = cv.parentElement.clientWidth; cv.height = cv.parentElement.clientHeight; 
        const ctx = cv.getContext('2d'); const w = cv.width, h = cv.height; const cx = w/2, cy = h/2, radius = Math.min(w,h)/2.6; 
        ctx.clearRect(0,0,w,h);
        
        const maxS = parseFloat(document.getElementById('scaleShots').value) || 6; 
        const maxX = parseFloat(document.getElementById('scaleXG').value) || 1.0; 
        const maxVals = [maxS, maxX, maxX]; 
        
        const labels = ["Tiros p90", "xG p90", "xGOT p90"]; 
        const angles = [ -Math.PI/2, (-Math.PI/2) + (2*Math.PI/3), (-Math.PI/2) + (4*Math.PI/3) ];
        
        ctx.strokeStyle = "#444"; ctx.lineWidth = 1; 
        for(let i=1; i<=5; i++) { ctx.beginPath(); for(let j=0; j<3; j++) { let r = (radius / 5) * i; let x = cx + r * Math.cos(angles[j]); let y = cy + r * Math.sin(angles[j]); if(j==0) ctx.moveTo(x,y); else ctx.lineTo(x,y); } ctx.closePath(); ctx.stroke(); }
        
        ctx.fillStyle = "#aaa"; ctx.font = "bold 10px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; 
        for(let j=0; j<3; j++) { let x = cx + radius * Math.cos(angles[j]); let y = cy + radius * Math.sin(angles[j]); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke(); let lblX = cx + (radius+20) * Math.cos(angles[j]); let lblY = cy + (radius+20) * Math.sin(angles[j]); ctx.fillText(labels[j], lblX, lblY); }
        
        radarDatasets.forEach(d => {
            const vals = [d.stats.shots90, d.stats.xg90, d.stats.xgot90]; 
            ctx.beginPath(); 
            for(let j=0; j<3; j++) { 
                let v = Math.min(vals[j], maxVals[j]); 
                let r = (v / maxVals[j]) * radius; 
                let x = cx + r * Math.cos(angles[j]); 
                let y = cy + r * Math.sin(angles[j]); 
                if(j==0) ctx.moveTo(x,y); else ctx.lineTo(x,y); 
            } 
            ctx.closePath(); 
            ctx.fillStyle = d.color; ctx.globalAlpha = 0.1; ctx.fill(); 
            ctx.globalAlpha = 1.0; ctx.strokeStyle = d.color; ctx.lineWidth = 2; ctx.stroke();
            for(let j=0; j<3; j++) { let v = Math.min(vals[j], maxVals[j]); let r = (v / maxVals[j]) * radius; let x = cx + r * Math.cos(angles[j]); let y = cy + r * Math.sin(angles[j]); ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fillStyle=d.color; ctx.fill(); }
        });
    }

    function toggleSeasonModal(show) { document.getElementById('seasonModal').style.display = show ? 'flex' : 'none'; if(show) { setTimeout(() => { drawSeasonChart('chartSeasonAtt', 'attack'); drawSeasonChart('chartSeasonDef', 'defense'); drawScatterChart('chartSeasonScatter'); }, 100); } }
    function saveToSeasonHistory() { const jor = inputs.jornada.value; if(!jor) { alert("Introduce un n√∫mero de Jornada primero"); return; } const existingIdx = seasonHistory.findIndex(s => s.jor === jor); const newData = { jor: jor, gf: matchData.stats.Propio.goals, xg_f: matchData.stats.Propio.xg, ga: matchData.stats.Rival.goals, xg_a: matchData.stats.Rival.xg }; if(existingIdx >= 0) { if(confirm(`La jornada ${jor} ya existe. ¬øSobrescribir?`)) { seasonHistory[existingIdx] = newData; } else return; } else { seasonHistory.push(newData); } seasonHistory.sort((a,b) => parseInt(a.jor) - parseInt(b.jor)); localStorage.setItem('seasonHistory_v1', JSON.stringify(seasonHistory)); alert("Datos guardados en historial de temporada."); drawSeasonCharts(); }
    function drawSeasonCharts() { drawSeasonChart('chartSeasonAtt', 'attack'); drawSeasonChart('chartSeasonDef', 'defense'); drawScatterChart('chartSeasonScatter'); }
    function clearSeasonHistory() { if(confirm("¬øBorrar todo el historial de la temporada?")) { seasonHistory = []; localStorage.setItem('seasonHistory_v1', JSON.stringify(seasonHistory)); toggleSeasonModal(false); } }
    
    function drawSeasonChart(canvasId, type) { const cv = document.getElementById(canvasId); if(!cv.parentElement) return; cv.width = cv.parentElement.clientWidth; cv.height = cv.parentElement.clientHeight; const ctx = cv.getContext('2d'); const w = cv.width, h = cv.height; ctx.fillStyle = "#161616"; ctx.fillRect(0,0,w,h); if(seasonHistory.length === 0) { ctx.fillStyle="#666"; ctx.textAlign="center"; ctx.fillText("No hay datos", w/2, h/2); return; } const pad = 30; const graphW = w - pad*2; const graphH = h - pad*2; let maxVal = 0; seasonHistory.forEach(s => { maxVal = Math.max(maxVal, s.gf, s.xg_f, s.ga, s.xg_a); }); maxVal = Math.ceil(maxVal + 1); ctx.strokeStyle = "#444"; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, h-pad); ctx.lineTo(w-pad, h-pad); ctx.stroke(); ctx.textAlign = "right"; ctx.fillStyle = "#fff"; ctx.font = "bold 10px Arial"; for(let i=0; i<=maxVal; i++) { let y = (h - pad) - (i / maxVal) * graphH; ctx.fillText(i, pad-5, y+3); ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w-pad, y); ctx.strokeStyle="rgba(255,255,255,0.05)"; ctx.stroke(); } let dataGoals, dataXG, colorGoals, colorXG, fillGoals, fillXG; if(type === 'attack') { dataGoals = seasonHistory.map(s => s.gf); dataXG = seasonHistory.map(s => s.xg_f); colorGoals = "#3498db"; fillGoals = "rgba(52, 152, 219, 0.4)"; colorXG = "#e67e22"; fillXG = "rgba(230, 126, 34, 0.4)"; } else { dataGoals = seasonHistory.map(s => s.ga); dataXG = seasonHistory.map(s => s.xg_a); colorGoals = "#3498db"; fillGoals = "rgba(52, 152, 219, 0.4)"; colorXG = "#e67e22"; fillXG = "rgba(230, 126, 34, 0.4)"; } const stepX = graphW / Math.max(1, seasonHistory.length - 1); const drawLine = (data, color, fill) => { if(data.length === 0) return; ctx.beginPath(); ctx.moveTo(pad, h-pad); data.forEach((val, i) => { let x = seasonHistory.length===1 ? w/2 : pad + (i * stepX); let y = (h - pad) - (val / maxVal) * graphH; ctx.lineTo(x, y); }); ctx.lineTo(seasonHistory.length===1?w/2:w-pad, h-pad); ctx.fillStyle = fill; ctx.fill(); ctx.beginPath(); data.forEach((val, i) => { let x = seasonHistory.length===1 ? w/2 : pad + (i * stepX); let y = (h - pad) - (val / maxVal) * graphH; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.stroke(); data.forEach((val, i) => { let x = seasonHistory.length===1 ? w/2 : pad + (i * stepX); let y = (h - pad) - (val / maxVal) * graphH; ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fillStyle = color; ctx.fill(); if(color === colorGoals) { ctx.fillStyle = "#fff"; ctx.font="bold 10px Arial"; ctx.textAlign="center"; ctx.fillText("J"+seasonHistory[i].jor, x, h-pad+12); } }); }; drawLine(dataXG, colorXG, fillXG); drawLine(dataGoals, colorGoals, fillGoals); }
    
    function drawScatterChart(canvasId) {
        const cv = document.getElementById(canvasId); if(!cv.parentElement) return; cv.width = cv.parentElement.clientWidth; cv.height = cv.parentElement.clientHeight; const ctx = cv.getContext('2d'); const w = cv.width, h = cv.height; ctx.fillStyle = "#161616"; ctx.fillRect(0,0,w,h);
        if(seasonHistory.length === 0) { ctx.fillStyle="#666"; ctx.textAlign="center"; ctx.fillText("No hay datos", w/2, h/2); return; }
        const pad = 50; const graphW = w - pad*2; const graphH = h - pad*2; let maxX = 0; let maxY = 0; seasonHistory.forEach(s => { maxX = Math.max(maxX, s.xg_f); maxY = Math.max(maxY, s.xg_a); }); let limit = Math.max(5, Math.ceil(Math.max(maxX, maxY) + 0.5)); 
        ctx.strokeStyle = "#888"; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(pad, h-pad); ctx.lineTo(w-pad, h-pad); ctx.stroke(); ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, h-pad); ctx.stroke(); 
        ctx.fillStyle = "#ffffff"; ctx.font = "bold 12px Arial"; ctx.textAlign = "center"; for(let i=0; i<=limit; i++) { let x = pad + (i/limit)*graphW; ctx.fillText(i, x, h-pad+20); ctx.beginPath(); ctx.moveTo(x, pad); ctx.lineTo(x, h-pad); ctx.strokeStyle="rgba(255,255,255,0.1)"; ctx.stroke(); }
        ctx.textAlign = "right"; for(let i=0; i<=limit; i++) { let y = (h-pad) - (i/limit)*graphH; ctx.fillText(i, pad-10, y+4); ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w-pad, y); ctx.strokeStyle="rgba(255,255,255,0.1)"; ctx.stroke(); }
        ctx.save(); ctx.fillStyle = "#ccc"; ctx.font = "bold 11px Arial"; ctx.textAlign = "center"; ctx.fillText("xG A FAVOR (Generado)", w/2, h-5); ctx.translate(15, h/2); ctx.rotate(-Math.PI/2); ctx.fillText("xG EN CONTRA (Concedido)", 0, 0); ctx.restore();
        ctx.beginPath(); ctx.moveTo(pad, h-pad); ctx.lineTo(w-pad, pad); ctx.strokeStyle = "rgba(255, 255, 255, 0.4)"; ctx.setLineDash([5, 5]); ctx.stroke(); ctx.setLineDash([]);
        
        ctx.lineWidth = 2; ctx.strokeStyle = "rgba(231, 76, 60, 0.8)";
        let l1_start_x = pad; let l1_start_y = (h-pad) - (1/limit)*graphH; let l1_end_x = pad + ((limit-1)/limit)*graphW; let l1_end_y = pad; ctx.beginPath(); ctx.moveTo(l1_start_x, l1_start_y); ctx.lineTo(l1_end_x, l1_end_y); ctx.stroke();
        let l2_start_x = pad + (1/limit)*graphW; let l2_start_y = h-pad; let l2_end_x = w-pad; let l2_end_y = (h-pad) - ((limit-1)/limit)*graphH; ctx.beginPath(); ctx.moveTo(l2_start_x, l2_start_y); ctx.lineTo(l2_end_x, l2_end_y); ctx.stroke();
        
        seasonHistory.forEach(s => { 
            let x = pad + (s.xg_f / limit) * graphW; let y = (h - pad) - (s.xg_a / limit) * graphH; 
            let col = "#f1c40f"; if(s.gf > s.ga) col = "#27ae60"; else if(s.gf < s.ga) col = "#c0392b"; 
            ctx.beginPath(); ctx.arc(x, y, 7, 0, Math.PI*2); ctx.fillStyle = col; ctx.fill(); ctx.strokeStyle = "#fff"; ctx.lineWidth=1.5; ctx.stroke(); 
            ctx.fillStyle = "#fff"; ctx.font="bold 11px Arial"; ctx.textAlign="left"; ctx.fillText("J"+s.jor, x+9, y+4); 
        });
    }

    function saveLooseMatch() { const t=prompt("Nombre","Partido"); if(t){ archiveHistory.push({id:Date.now(),date:new Date().toLocaleDateString(),title:t,stats:JSON.parse(JSON.stringify(matchData.stats)),shots:JSON.parse(JSON.stringify(matchData.shots))}); localStorage.setItem('archiveHistory_v1',JSON.stringify(archiveHistory)); alert("Guardado"); } }
    function viewLooseMatches() { const c=document.getElementById('looseContainer'); c.innerHTML=""; archiveHistory.forEach((r,i)=>{c.innerHTML+=`<div class="loose-item"><div class="loose-info"><strong>${r.title}</strong> (${r.date})</div><button class="btn-delete" onclick="archiveHistory.splice(${i},1);localStorage.setItem('archiveHistory_v1',JSON.stringify(archiveHistory));viewLooseMatches();">x</button></div>`;}); document.getElementById('looseModal').style.display='flex'; }
    function resetMatch() { if(confirm("Borrar?")) { matchData={jornada:"",shots:[],stats:{Propio:{xg:0,xgot:0,goals:0,count:0},Rival:{xg:0,xgot:0,goals:0,count:0}}}; inputs.min.value=0; inputs.sec.value=0; saveData(); updateUI(); draw(); } }
    function downloadExcel() { let c = "\uFEFFMinuto;Seg;Jugador;Equipo;Resultado;xG;xGOT\n"; matchData.shots.forEach(s => { c += `${s.minute};${s.second};${s.player};${s.team};${s.result};${s.xg.toFixed(3)};${s.xgot.toFixed(3)}\n`; }); const l = document.createElement("a"); l.href = URL.createObjectURL(new Blob([c], {type:'text/csv;charset=utf-8;'})); l.download = `Data.csv`; l.click(); }
    function importCSV(input) {alert("Importado");}
    window.saveCanvas = function(cid, fname) { const c=document.getElementById(cid); if(c){const l=document.createElement('a'); l.download=`${fname}.png`; l.href=c.toDataURL(); l.click();} };

    // --- FIX STARTUP ---
    window.onload = function() {
        setTimeout(()=>{ loadData(); draw(); updateUI(); }, 200);
    };
    function draw() { const c = calculate(); ui.liveXG.innerText = c.xg.toFixed(3); ui.liveXGOT.innerText = c.xgot.toFixed(3); drawPitch(c); drawGoal(c); }

    Object.values(inputs).forEach(i=>i.addEventListener('input',(e)=>{if(e.target.id==='jornadaInput')saveData();else draw()}));
    window.addEventListener('resize',()=>{draw();updateUI()});
</script>
</body>
</html>