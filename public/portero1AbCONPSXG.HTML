<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GK Elite Pro v19.6 - xGOT Fixed</title>
    <style>
        /* --- ESTILOS BASE --- */
        :root {
            --bg: #121212; --card: #1e1e24; --border: #333;
            --accent: #9b59b6; --success: #27ae60; --danger: #c0392b; --warn: #f39c12; --info: #2980b9;
            --text: #ecf0f1; --field: #388e3c;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { min-height: 50px; background: #000; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 8px; flex-shrink: 0; gap: 5px;}
        .filters { display: flex; gap: 6px; align-items: center; flex: 1; }
        .hdr-select { background: #222; color: #fff; border: 1px solid #444; padding: 6px; border-radius: 6px; font-weight: bold; max-width: 120px;}
        .btn-icon { background: #2d3436; border: 1px solid #444; color: #fff; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 1.1rem; }
        .btn-edit { padding: 4px 8px; font-size: 0.8rem; background: #444; border: 1px solid #666; color: #fff; border-radius: 4px; cursor: pointer; margin-right: 5px;}

        /* LAYOUT */
        .layout { display: flex; flex: 1; overflow: hidden; height: 100%; position: relative; }
        .view-container { flex: 55; display: flex; flex-direction: column; border-right: 1px solid var(--border); padding: 5px; gap: 5px; background: #000; position: relative;}
        .ctrl-col { flex: 45; background: var(--card); display: flex; flex-direction: column; min-width: 300px; overflow-y: auto; }

        /* VISTAS */
        #viewField { display: flex; flex-direction: column; gap: 5px; height: 100%; width: 100%; }
        
        #viewRadar { 
            display: none; flex-direction: column; height: 100%; width: 100%; 
            background: #151515; padding: 10px; overflow-y: auto; 
        }
        #viewRadar.active { display: flex; }
        
        .radar-canvas-container { flex: 1; min-height: 250px; display: flex; align-items: center; justify-content: center; width: 100%; }
        
        /* GRID DE ESTADISTICAS */
        .radar-stats-container { flex-shrink: 0; display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; padding-top: 10px; width: 100%; }
        .stat-box { background: #222; padding: 6px; border-radius: 6px; border: 1px solid #444; text-align: center; display: flex; flex-direction: column; justify-content: center; min-height: 55px;}
        .stat-val { font-size: 1rem; font-weight: bold; display: block; margin-bottom: 2px; }
        .stat-lbl { font-size: 0.6rem; color: #aaa; text-transform: uppercase; }
        
        /* Celdas espec√≠ficas */
        .box-psxg { grid-column: span 3; background: #1a1a20; border: 1px solid #555; flex-direction: row; align-items: center; justify-content: space-around; gap: 10px;}
        .box-psxg .stat-val { font-size: 1.4rem; }

        /* CAMPOS CANVAS */
        .canvas-box { position: relative; width: 100%; border-radius: 6px; overflow: hidden; border: 1px solid #444; background: #222; flex-shrink: 0; touch-action: none; }
        #boxPitch { height: 50%; background: var(--field); }
        #boxGoal { height: 35%; background: #333; }
        canvas { width: 100%; height: 100%; display: block; }
        
        .mode-switch { position: absolute; top: 5px; right: 5px; display: flex; background: rgba(0,0,0,0.8); border-radius: 6px; border: 1px solid #555; z-index: 10; }
        .mode-opt { padding: 4px 8px; font-size: 0.65rem; font-weight: bold; color: #aaa; cursor: pointer; }
        .mode-opt.active { background: #f1c40f; color: #000; }

        /* CONTROLES */
        .scroll-area { flex: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 8px; }
        .ctrl-panel { background: #2d2d2d; padding: 8px; border-radius: 8px; border: 1px solid #3a3a3a; }
        .panel-header { font-size: 0.7rem; color: var(--accent); font-weight: bold; text-transform: uppercase; margin-bottom: 6px; border-bottom: 1px solid #444; padding-bottom: 4px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }

        .btn { padding: 0; border: none; border-radius: 6px; color: #fff; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.1s; font-size: 0.8rem; min-height: 44px; box-shadow: 0 2px 0 rgba(0,0,0,0.3); position: relative; }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn small { font-size: 0.6rem; opacity: 0.7; font-weight: normal; margin-top: 2px; }
        
        .b-def { background: #27ae60; } .b-aer { background: #e67e22; } .b-duel { background: #c0392b; } .b-off { background: #2980b9; } .b-aux { background: #555; border: 1px dashed #777; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-overlay.open { display: flex; }
        .modal-box { background: #1e1e24; border: 1px solid #555; width: 90%; max-width: 400px; border-radius: 12px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; gap: 10px; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-title { text-align: center; color: var(--accent); font-weight: bold; font-size: 1.1rem; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 8px;}
        .sub-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-sub { background: #333; border: 1px solid #555; color: #eee; padding: 12px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; }
        .btn-sub:active { background: var(--accent); color: #fff; }
        
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        .btn-res { padding: 15px; border-radius: 8px; border: none; font-weight: bold; font-size: 1rem; color: #fff; cursor: pointer; }
        .res-ok { background: #27ae60; border: 2px solid #2ecc71; } 
        .res-ko { background: #c0392b; border: 2px solid #e74c3c; } 
        .btn-close { width: 100%; background: transparent; border: 1px solid #444; color: #888; padding: 8px; border-radius: 6px; cursor: pointer;}

        /* INPUT XGOT */
        .xgot-container { margin: 5px 0; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #444; }
        .xgot-label { display: block; text-align: center; color: #aaa; font-size: 0.7rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .xgot-input { width: 100%; background: #222; color: #f1c40f; border: 1px solid #555; padding: 10px; font-size: 1.5rem; font-weight: bold; text-align: center; border-radius: 6px; outline: none; }
        .xgot-input:focus { border-color: #f1c40f; }

        /* LOG */
        .log-area { flex: 0 0 120px; background: #111; border-top: 1px solid var(--border); overflow-y: auto; font-size: 0.7rem; }
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 4px 6px; text-align: left; border-bottom: 1px solid #222; }
        th { background: #222; position: sticky; top: 0; }

        @media (max-width: 900px) {
            .layout { flex-direction: column; }
            .view-container { flex: none; height: auto; padding: 5px; min-height: 350px;}
            #boxPitch { height: 200px; } #boxGoal { height: 150px; }
            .ctrl-col { flex: 1; }
        }
    </style>
</head>
<body>

<header>
    <div class="filters">
        <div style="display:flex; align-items:center; gap:4px;">
            <select id="selGK" class="hdr-select" onchange="updateGK()"></select>
            <button class="btn-edit" onclick="renameGK()" title="Renombrar portero">‚úèÔ∏è</button>
            <button class="btn-edit" onclick="addGK()" title="A√±adir portero">‚ûï</button>
        </div>
        <div style="display:flex; align-items:center; gap:4px;">
            <select id="selMatch" class="hdr-select" onchange="setMatch()"></select>
            <button class="btn-edit" onclick="addFriendly()" title="A√±adir amistoso">+Am</button>
        </div>
    </div>
    <div class="tools">
        <button class="btn-icon" onclick="toggleView()">üìä</button>
        <button class="btn-icon" onclick="downloadCSV()">üíæ</button>
        <button class="btn-icon" onclick="clearCurrentMatch()" title="Borrar solo este partido/portero">üßπ</button>
    </div>
</header>

<div class="layout">
    <div class="view-container">
        <div id="viewField">
            <div class="canvas-box" id="boxPitch">
                <div class="mode-switch">
                    <div class="mode-opt active" id="mPitchOrg" onclick="setMode('pitch','org')">ORIGEN</div>
                    <div class="mode-opt" id="mPitchAct" onclick="setMode('pitch','act')">ACCI√ìN</div>
                </div>
                <canvas id="cvPitch"></canvas>
            </div>
            <div class="canvas-box" id="boxGoal">
                <div class="mode-switch">
                    <div class="mode-opt active" id="mGoalBall" onclick="setMode('goal','ball')">BAL√ìN</div>
                    <div class="mode-opt" id="mGoalGK" onclick="setMode('goal','gk')">PORTERO</div>
                </div>
                <canvas id="cvGoal"></canvas>
            </div>
        </div>

        <div id="viewRadar">
            <div class="radar-canvas-container" id="boxRadarCanvas">
                <canvas id="cvRadar"></canvas>
            </div>
            <div id="compareList" style="display:flex; flex-wrap:wrap; gap:6px; margin:6px 0 2px;"></div>
            <div class="radar-stats-container" id="radarStats"></div>
        </div>
    </div>

    <div class="ctrl-col">
        <div class="scroll-area">
            <div class="ctrl-panel">
                <div class="panel-header">1. DEFENSA DE DISPARO</div>
                <div class="grid-2">
                    <button class="btn b-def" onclick="openMenu('Defensa', 'Blocaje')">BLOCAJE<small>Raso, Alto, Ca√≠da...</small></button>
                    <button class="btn b-def" onclick="openMenu('Defensa', 'Desv√≠o')">DESV√çO<small>Mano cambiada/natural...</small></button>
                </div>
                <div class="grid-2" style="margin-top:6px">
                     <button class="btn b-aux" onclick="registerDirect('Defensa', 'Gol Imparable', 'KO')">GOL IMPARABLE</button>
                     <button class="btn b-aux" style="border-color:var(--danger); color:var(--danger)" onclick="registerDirect('Defensa', 'Error Grave', 'KO')">ERROR / FALLO</button>
                </div>
            </div>

            <div class="ctrl-panel">
                <div class="panel-header">2. DUELO DIRECTO</div>
                <button class="btn b-duel" style="width:100%" onclick="openMenu('Duelo', '1 vs 1')">1 vs 1 (MANO A MANO)<small>Cruz, Achique, Ataque...</small></button>
            </div>

            <div class="ctrl-panel">
                <div class="panel-header">3. JUEGO A√âREO</div>
                <div class="grid-2">
                    <button class="btn b-aer" onclick="openMenu('A√©reo', 'Salida')">SALIDA<small>Pu√±os, Blocaje...</small></button>
                    <button class="btn b-aux" onclick="registerDirect('A√©reo', 'Duda / Fallo', 'KO')">FALLO A√âREO</button>
                </div>
            </div>

            <div class="ctrl-panel">
                <div class="panel-header">4. OFENSIVO</div>
                <button class="btn b-off" style="width:100%" onclick="openMenu('Ofensivo', 'Distribuci√≥n')">DISTRIBUCI√ìN<small>Volea, Mano, Apoyos...</small></button>
            </div>
        </div>

        <div class="log-area">
            <table><thead><tr><th>X</th><th>Jor</th><th>Acci√≥n</th><th>Var</th><th>xGOT</th><th>Res</th></tr></thead><tbody id="logTable"></tbody></table>
        </div>
    </div>
</div>

<div id="subModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-box" id="modalBox">
        <div class="modal-title" id="modalTitle">OPCIONES</div>
        <div id="modalContent"></div>
        <button class="btn-close" onclick="closeModal()">Cancelar</button>
    </div>
</div>

<script>
    // --- CONFIG Y ESTADO PERSISTENTE ---
    const STORAGE_KEY = 'gk_suite_v20';
    const COLORS = ['#3498db', '#e74c3c', '#f39c12', '#9b59b6', '#2ecc71', '#1abc9c', '#d35400'];

    const ACTIONS_DB = {
        "Defensa": { "Blocaje": ["Raso", "Media Altura", "Alto", "Con ca√≠da"], "Desv√≠o": ["Mano cambiada", "Mano natural", "Pie", "Rechace Corto"] },
        "A√©reo": { "Salida": ["Pu√±os (1 o 2)", "Blocaje A√©reo", "Prolongaci√≥n"] },
        "Duelo": { "1 vs 1": ["La Cruz", "Achique", "Ataque bal√≥n"] },
        "Ofensivo": { "Distribuci√≥n": ["Volea", "Bote pronto", "Mano (B√©isbol)", "Mano (Jabalina)", "Mano (Rasa)", "Pie (Raso)", "Pie (Largo)", "Apoyo Pie Corto", "Apoyo Pie Largo"] }
    };

    let store = {
        gks: [{ id: 1, name: 'Portero 1' }],
        gk: 1,
        compare: [1],
        match: 'single',
        friends: [],
        pitch: { ox: 50, oy: 10, ax: 50, ay: 80 },
        goal: { bx: 50, by: 50, gx: 50, gy: 50 },
        modeP: 'org',
        modeG: 'ball',
        view: 'field',
        actions: []
    };

    let pendingCat = ""; let pendingKey = ""; let pendingVar = "";

    // --- INIT ---
    function loadStore() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try { store = { ...store, ...JSON.parse(saved) }; } catch {}
        }
        if (!store.gk && store.gks.length) store.gk = store.gks[0].id;
        if (!Array.isArray(store.compare)) store.compare = [store.gk];
        ensureCompareIncludesCurrent(true);
    }

    function saveStore() { localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }

    function init() {
        loadStore();
        renderGKSelect();
        renderMatchSelect();
        renderCompareList();
        resize();
        updateLog();
        if (store.view === 'radar') drawRadar();
    }

    // --- GK MANAGEMENT ---
    function renderGKSelect() {
        const s = document.getElementById('selGK');
        s.innerHTML = '';
        store.gks.forEach((g) => {
            const o = document.createElement('option');
            o.value = g.id; o.innerText = g.name; s.appendChild(o);
        });
        s.value = store.gk;
    }

    function ensureCompareIncludesCurrent(force) {
        if (force && !store.compare.includes(store.gk)) store.compare.push(store.gk);
        store.compare = Array.from(new Set(store.compare));
    }

    function addGK() {
        const name = prompt('Nombre del portero:');
        if (!name) return;
        const id = Date.now();
        store.gks.push({ id, name: name.trim() });
        store.gk = id;
        ensureCompareIncludesCurrent(true);
        saveStore();
        renderGKSelect();
        renderCompareList();
        updateLog();
        drawAll();
    }

    function renameGK() {
        const current = store.gks.find(g => g.id == store.gk);
        if (!current) return;
        const nn = prompt('Nuevo nombre:', current.name);
        if (nn && nn.trim() !== '') {
            current.name = nn.trim();
            saveStore();
            renderGKSelect();
            renderCompareList();
            if (store.view === 'radar') drawRadar();
        }
    }

    function updateGK() {
        store.gk = parseInt(document.getElementById('selGK').value, 10);
        ensureCompareIncludesCurrent(true);
        saveStore();
        renderCompareList();
        updateLog();
        if (store.view === 'radar') drawRadar(); else drawAll();
    }

    // --- MATCH MANAGEMENT ---
    function renderMatchSelect() {
        const s = document.getElementById('selMatch');
        s.innerHTML = '';
        const single = document.createElement('option'); single.value = 'single'; single.textContent = '‚≠ê Partido √önico'; s.appendChild(single);
        const grp = document.createElement('optgroup'); grp.label = 'Temporada Regular';
        for (let i = 1; i <= 38; i++) { const o = document.createElement('option'); o.value = String(i); o.innerText = `Jornada ${i}`; grp.appendChild(o); }
        s.appendChild(grp);
        if (store.friends.length) {
            const g2 = document.createElement('optgroup'); g2.label = 'Amistosos';
            store.friends.forEach(f => { const o = document.createElement('option'); o.value = f.id; o.innerText = f.name; g2.appendChild(o); });
            s.appendChild(g2);
        }
        s.value = store.match;
        if (!s.value) { store.match = 'single'; s.value = store.match; }
    }

    function addFriendly() {
        const name = prompt('Nombre del amistoso:');
        if (!name) return;
        const id = 'F-' + Date.now();
        store.friends.push({ id, name: name.trim() });
        store.match = id;
        saveStore();
        renderMatchSelect();
        setMatch();
    }

    function setMatch() {
        store.match = document.getElementById('selMatch').value;
        saveStore();
        updateLog();
        if (store.view === 'radar') drawRadar();
    }

    // --- MEN√öS ---
    const modal = document.getElementById('subModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');

    function openMenu(category, actionKey) {
        pendingCat = category; pendingKey = actionKey;
        modalTitle.innerText = `${actionKey}`;
        let html = '<div class="sub-grid">';
        ACTIONS_DB[category][actionKey].forEach(variant => { html += `<button class="btn-sub" onclick="askResult('${variant}')">${variant}</button>`; });
        html += '</div>';
        modalContent.innerHTML = html;
        modal.classList.add('open');
    }

    function askResult(variant) {
        pendingVar = variant;
        modalTitle.innerText = `RESULTADO Y XGOT`;

        const showXgot = (pendingCat === 'Defensa' || pendingCat === 'Duelo');
        let html = `
            <div class="res-grid">
                <button class="btn-res res-ok" onclick="finalSave('OK')">‚úÖ PARADA / √âXITO</button>
                <button class="btn-res res-ko" onclick="finalSave('KO')">‚ùå GOL / ERROR</button>
            </div>
        `;

        if (showXgot) {
            html += `
            <div class="xgot-container">
                <label class="xgot-label">Valor xGOT (Probabilidad de Gol 0.00 - 0.99)</label>
                <input type="number" id="inputXGOT" class="xgot-input" step="0.01" min="0" max="0.99" placeholder="0.35">
            </div>
            `;
        } else {
            html += `<input type="hidden" id="inputXGOT" value="0">`;
        }

        modalContent.innerHTML = html;
        setTimeout(() => {
            const inp = document.getElementById('inputXGOT');
            if (inp && inp.type !== 'hidden') inp.focus();
        }, 120);
    }

    function registerDirect(cat, action, res) {
        pendingCat = cat; pendingKey = action; pendingVar = '-';
        if (cat === 'Defensa' || cat === 'Duelo' || action.toLowerCase().includes('fallo')) {
            modalTitle.innerText = `${action}`;
            const html = `
                <div style="text-align:center; margin-bottom:10px; color:#ccc;">Introduce el xGOT de esta jugada</div>
                <div class="xgot-container">
                    <label class="xgot-label">xGOT (0.00 - 0.99)</label>
                    <input type="number" id="inputXGOT" class="xgot-input" step="0.01" min="0" max="0.99" placeholder="0.50">
                </div>
                <button class="btn-res res-ko" style="width:100%" onclick="finalSave('${res}')">CONFIRMAR ${action}</button>
            `;
            modalContent.innerHTML = html;
            modal.classList.add('open');
            setTimeout(() => { document.getElementById('inputXGOT').focus(); }, 120);
        } else {
            saveAction(cat, action, '-', res, 0);
        }
    }

    function finalSave(result) {
        const inp = document.getElementById('inputXGOT');
        let xgVal = 0;
        if (inp && inp.value !== "") xgVal = parseFloat(inp.value);
        if (isNaN(xgVal)) xgVal = 0;
        closeModal();
        saveAction(pendingCat, pendingKey, pendingVar, result, xgVal);
    }

    function closeModal(e) { if (!e || e.target === modal || e.target.classList.contains('btn-close')) modal.classList.remove('open'); }

    // --- DATA OPS ---
    function saveAction(cat, key, variant, result, xgot) {
        const act = { id: Date.now(), gk: store.gk, match: store.match, cat, key, var: variant, res: result, xgot: xgot || 0, pitch: { ...store.pitch }, goal: { ...store.goal } };
        store.actions.unshift(act);
        saveStore();
        updateLog();
        if (store.view === 'radar') drawRadar(); else drawAll();
    }

    function deleteAction(id) {
        if (!confirm('¬øEliminar acci√≥n?')) return;
        store.actions = store.actions.filter(a => a.id !== id);
        saveStore();
        updateLog();
        if (store.view === 'radar') drawRadar();
    }

    function clearCurrentMatch() {
        if (!confirm('¬øBorrar solo las acciones de este partido y portero?')) return;
        store.actions = store.actions.filter(a => !(a.gk == store.gk && a.match === store.match));
        saveStore();
        updateLog();
        if (store.view === 'radar') drawRadar();
    }

    function updateLog() {
        const tbody = document.getElementById('logTable');
        tbody.innerHTML = '';
        store.actions
            .filter(a => a.gk == store.gk && a.match === store.match)
            .forEach(a => {
                const tr = document.createElement('tr');
                const col = a.res === 'OK' ? '#2ecc71' : '#e74c3c';
                const xgShow = (a.cat === 'Defensa' || a.cat === 'Duelo') ? `<b>${(a.xgot || 0).toFixed(2)}</b>` : '-';
                tr.innerHTML = `<td style="color:#c0392b;cursor:pointer;font-weight:bold" onclick="deleteAction(${a.id})">√ó</td><td>${a.match === 'single' ? '‚≠ê' : 'J'+a.match}</td><td><b>${a.key}</b></td><td>${a.var}</td><td>${xgShow}</td><td style="color:${col}; font-weight:bold">${a.res}</td>`;
                tbody.appendChild(tr);
            });
    }

    // --- VIEW SWITCH ---
    function toggleView() {
        store.view = (store.view === 'field') ? 'radar' : 'field';
        document.getElementById('viewField').style.display = (store.view === 'field') ? 'flex' : 'none';
        const radarDiv = document.getElementById('viewRadar');
        radarDiv.classList.toggle('active', store.view === 'radar');
        if (store.view === 'radar') setTimeout(drawRadar, 120); else resize();
        saveStore();
    }

    const cvP = document.getElementById('cvPitch'); const cvG = document.getElementById('cvGoal');

    function resize() {
        if (store.view !== 'field') return;
        cvP.width = cvP.parentElement.clientWidth; cvP.height = cvP.parentElement.clientHeight;
        cvG.width = cvG.parentElement.clientWidth; cvG.height = cvG.parentElement.clientHeight;
        drawAll();
    }
    window.onresize = resize; setTimeout(resize, 120);

    function setMode(canvas, m) {
        if (canvas === 'pitch') {
            store.modeP = m;
            document.getElementById('mPitchOrg').className = `mode-opt ${m === 'org' ? 'active' : ''}`;
            document.getElementById('mPitchAct').className = `mode-opt ${m === 'act' ? 'active' : ''}`;
        }
        if (canvas === 'goal') {
            store.modeG = m;
            document.getElementById('mGoalBall').className = `mode-opt ${m === 'ball' ? 'active' : ''}`;
            document.getElementById('mGoalGK').className = `mode-opt ${m === 'gk' ? 'active' : ''}`;
        }
        saveStore();
    }

    function touchHandler(e, cvType) {
        if (store.view !== 'field') return;
        e.preventDefault();
        const cv = e.target; const rect = cv.getBoundingClientRect();
        const t = e.changedTouches ? e.changedTouches[0] : e;
        const x = (t.clientX - rect.left) / rect.width * 100;
        const y = (t.clientY - rect.top) / rect.height * 100;
        if (cvType === 'pitch') { if (store.modeP === 'org') { store.pitch.ox = x; store.pitch.oy = y; } else { store.pitch.ax = x; store.pitch.ay = y; } }
        else { if (store.modeG === 'ball') { store.goal.bx = x; store.goal.by = y; } else { store.goal.gx = x; store.goal.gy = y; } }
        saveStore();
        drawAll();
    }
    [cvP, cvG].forEach(c => {
        c.addEventListener('mousedown', e => touchHandler(e, c === cvP ? 'pitch' : 'goal'));
        c.addEventListener('touchstart', e => touchHandler(e, c === cvP ? 'pitch' : 'goal'), { passive: false });
        c.addEventListener('touchmove', e => touchHandler(e, c === cvP ? 'pitch' : 'goal'), { passive: false });
    });

    // --- DRAW FIELD & GOAL ---
    function drawAll() {
        const ctxP = cvP.getContext('2d'); const w = cvP.width, h = cvP.height; const m = h / 60; const fw = 68 * m; const sx = (w - fw) / 2; const ty = 10;
        ctxP.fillStyle = "#388e3c"; ctxP.fillRect(0,0,w,h);
        ctxP.fillStyle = "rgba(0,0,0,0.05)"; for (let i = 0; i < h; i += 5.5 * m * 2) ctxP.fillRect(0, i, w, 5.5 * m);
        ctxP.lineWidth = 2; ctxP.strokeStyle = "rgba(255,255,255,0.7)";
        ctxP.strokeRect(sx, ty, fw, h - ty); ctxP.strokeRect(sx + (fw - 40.32 * m) / 2, ty, 40.32 * m, 16.5 * m); ctxP.strokeRect(sx + (fw - 18.32 * m) / 2, ty, 18.32 * m, 5.5 * m);
        ctxP.beginPath(); ctxP.arc(w / 2, ty + 11 * m, 2, 0, Math.PI * 2); ctxP.fillStyle = "#fff"; ctxP.fill(); ctxP.stroke();
        ctxP.beginPath(); ctxP.arc(w / 2, ty + 11 * m, 9.15 * m, 0.65, Math.PI - 0.65); ctxP.stroke();

        ctxP.beginPath(); ctxP.moveTo(store.pitch.ox / 100 * w, store.pitch.oy / 100 * h); ctxP.lineTo(store.pitch.ax / 100 * w, store.pitch.ay / 100 * h);
        ctxP.setLineDash([5, 5]); ctxP.strokeStyle = "rgba(255,255,255,0.6)"; ctxP.stroke(); ctxP.setLineDash([]);
        ctxP.beginPath(); ctxP.arc(store.pitch.ox / 100 * w, store.pitch.oy / 100 * h, 6, 0, Math.PI * 2); ctxP.fillStyle = "#f1c40f"; ctxP.fill();
        ctxP.beginPath(); ctxP.arc(store.pitch.ax / 100 * w, store.pitch.ay / 100 * h, 6, 0, Math.PI * 2); ctxP.fillStyle = "#3498db"; ctxP.fill();

        const ctxG = cvG.getContext('2d'); const gw = cvG.width, gh = cvG.height;
        ctxG.clearRect(0, 0, gw, gh); ctxG.fillStyle = "#444"; ctxG.fillRect(0, 0, gw, gh);
        const mx = gw * 0.2, my = gh * 0.25, fy = gh - 30, gx = mx, gy = my, g_w = gw - mx * 2, g_h = fy - my;
        ctxG.fillStyle = "#222"; ctxG.fillRect(0, 0, gw, fy); ctxG.fillStyle = "#27ae60"; ctxG.fillRect(0, fy, gw, gh - fy);
        ctxG.fillStyle = "rgba(255,255,255,0.1)"; ctxG.fillRect(gx, gy, g_w, g_h);
        ctxG.strokeStyle = "#ecf0f1"; ctxG.lineWidth = 6; ctxG.lineJoin = "round";
        ctxG.beginPath(); ctxG.moveTo(gx, fy); ctxG.lineTo(gx, gy); ctxG.lineTo(gx + g_w, gy); ctxG.lineTo(gx + g_w, fy); ctxG.stroke();

        drawGKBody(ctxG, store.goal.gx / 100 * gw, store.goal.gy / 100 * gh, g_h * 0.75, '#3498db');

        ctxG.beginPath(); ctxG.arc(store.goal.bx / 100 * gw, store.goal.by / 100 * gh, 7, 0, Math.PI * 2); ctxG.fillStyle = "#e67e22"; ctxG.fill(); ctxG.strokeStyle = "#fff"; ctxG.lineWidth = 2; ctxG.stroke();
    }

    function drawGKBody(ctx, x, y, h, col) {
        ctx.save(); ctx.translate(x, y); const s = h / 120; ctx.scale(s * 0.7, s); ctx.fillStyle = col;
        ctx.beginPath(); ctx.arc(0, -50, 11, 0, Math.PI * 2);
        ctx.moveTo(-22, -35); ctx.lineTo(22, -35); ctx.lineTo(42, -10); ctx.lineTo(52, 10); ctx.lineTo(42, 14); ctx.lineTo(32, 0); ctx.lineTo(10, 15);
        ctx.lineTo(30, 40); ctx.lineTo(35, 60); ctx.lineTo(25, 60); ctx.lineTo(15, 40); ctx.lineTo(2, 25); ctx.lineTo(-2, 25);
        ctx.lineTo(-15, 40); ctx.lineTo(-25, 60); ctx.lineTo(-35, 60); ctx.lineTo(-30, 40); ctx.lineTo(-10, 15);
        ctx.lineTo(-32, 0); ctx.lineTo(-42, 14); ctx.lineTo(-52, 10); ctx.lineTo(-42, -10); ctx.lineTo(-22, -35);
        ctx.fill(); ctx.restore();
    }

    // --- RADAR ---
    function renderCompareList() {
        const c = document.getElementById('compareList');
        if (!c) return;
        c.innerHTML = '';
        store.gks.forEach((g, i) => {
            const wrap = document.createElement('div');
            wrap.style = `display:flex;align-items:center;gap:6px;background:#222;padding:4px 8px;border-radius:10px;border:1px solid ${COLORS[i % COLORS.length]}`;
            const dot = document.createElement('span'); dot.style = `width:10px;height:10px;border-radius:50%;background:${COLORS[i % COLORS.length]}`;
            const chk = document.createElement('input'); chk.type = 'checkbox'; chk.checked = store.compare.includes(g.id); chk.onclick = () => toggleCompare(g.id);
            const lbl = document.createElement('span'); lbl.style = 'color:#ccc;font-size:0.75rem;'; lbl.innerText = g.name;
            wrap.appendChild(dot); wrap.appendChild(chk); wrap.appendChild(lbl); c.appendChild(wrap);
        });
    }

    function toggleCompare(id) {
        if (store.compare.includes(id)) store.compare = store.compare.filter(c => c !== id); else store.compare.push(id);
        ensureCompareIncludesCurrent(true);
        saveStore();
        renderCompareList();
        if (store.view === 'radar') drawRadar();
    }

    function collectStatsForGK(id) {
        const stats = { saves: { ok: 0, tot: 0 }, air: { ok: 0, tot: 0 }, foot: { ok: 0, tot: 0 }, hand: { ok: 0, tot: 0 }, xg_total: 0, goals_conceded: 0 };
        store.actions.forEach(a => {
            if (a.gk != id) return;
            if (a.cat === 'Defensa' || a.cat === 'Duelo') { stats.saves.tot++; if (a.res === 'OK') stats.saves.ok++; stats.xg_total += (a.xgot || 0); if (a.res === 'KO') stats.goals_conceded++; }
            if (a.cat === 'A√©reo') { stats.air.tot++; if (a.res === 'OK') stats.air.ok++; }
            if (a.cat === 'Ofensivo') {
                if ((a.var || '').includes('Pie') || (a.var || '').includes('Volea') || (a.var || '').includes('Bote')) {
                    stats.foot.tot++; if (a.res === 'OK') stats.foot.ok++;
                } else {
                    stats.hand.tot++; if (a.res === 'OK') stats.hand.ok++;
                }
            }
        });
        const pct = (o) => o.tot > 0 ? (o.ok / o.tot) : 0;
        const psxgRaw = stats.xg_total - stats.goals_conceded;
        let psxgNorm = 0.5 + (psxgRaw / 3.0); psxgNorm = Math.max(0.1, Math.min(1, psxgNorm));
        return { data: [pct(stats.saves), pct(stats.foot), pct(stats.hand), pct(stats.air), psxgNorm], stats, psxgRaw };
    }

    function drawRadar() {
        const box = document.getElementById('boxRadarCanvas');
        const cv = document.getElementById('cvRadar');
        cv.width = box.clientWidth; cv.height = box.clientHeight;
        const ctx = cv.getContext('2d');
        const w = cv.width, h = cv.height;
        const cx = w / 2, cy = h / 2, r = Math.min(w, h) * 0.35;

        ctx.clearRect(0, 0, w, h);
        ctx.strokeStyle = "#444"; ctx.lineWidth = 1; ctx.fillStyle = "#aaa"; ctx.font = "bold 10px sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle";

        const labels = ["PARADAS", "J. PIE", "J. MANO", "A√âREO", "PSxG +/-"];
        const sides = 5;
        for (let level = 1; level <= 4; level++) {
            ctx.beginPath();
            for (let i = 0; i < sides; i++) {
                const ang = (Math.PI * 2 * i) / sides - Math.PI / 2;
                const rad = r * (level / 4);
                const x = cx + Math.cos(ang) * rad, y = cy + Math.sin(ang) * rad;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.closePath(); ctx.stroke();
        }
        for (let i = 0; i < sides; i++) {
            const ang = (Math.PI * 2 * i) / sides - Math.PI / 2;
            const x = cx + Math.cos(ang) * (r + 24), y = cy + Math.sin(ang) * (r + 24);
            ctx.fillText(labels[i], x, y);
        }

        // Pol√≠gonos comparados
        store.compare.forEach((id, idx) => {
            const { data } = collectStatsForGK(id);
            ctx.beginPath();
            for (let i = 0; i < sides; i++) {
                const ang = (Math.PI * 2 * i) / sides - Math.PI / 2;
                const val = Math.max(0.1, data[i]);
                const x = cx + Math.cos(ang) * (r * val);
                const y = cy + Math.sin(ang) * (r * val);
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.closePath();
            const col = COLORS[idx % COLORS.length];
            ctx.strokeStyle = col; ctx.lineWidth = (id == store.gk) ? 3 : 1.5; ctx.stroke();
            ctx.fillStyle = col + '33'; ctx.fill();
        });

        // Stats del GK activo
        const activeStats = collectStatsForGK(store.gk);
        const s = activeStats.stats;
        const psxgRaw = activeStats.psxgRaw;
        const psxgColor = psxgRaw >= 0 ? '#2ecc71' : '#e74c3c';
        const psxgSign = psxgRaw > 0 ? '+' : '';

        document.getElementById('radarStats').innerHTML = `
            <div class="stat-box"><span class="stat-lbl">PARADAS</span><span class="stat-val" style="color:#2ecc71">${Math.round(activeStats.data[0]*100)}%</span><small>${s.saves.ok}/${s.saves.tot}</small></div>
            <div class="stat-box"><span class="stat-lbl">J. PIE</span><span class="stat-val" style="color:#3498db">${Math.round(activeStats.data[1]*100)}%</span><small>${s.foot.ok}/${s.foot.tot}</small></div>
            <div class="stat-box"><span class="stat-lbl">J. MANO</span><span class="stat-val" style="color:#9b59b6">${Math.round(activeStats.data[2]*100)}%</span><small>${s.hand.ok}/${s.hand.tot}</small></div>
            <div class="stat-box"><span class="stat-lbl">A√âREO</span><span class="stat-val" style="color:#f39c12">${Math.round(activeStats.data[3]*100)}%</span><small>${s.air.ok}/${s.air.tot}</small></div>
            <div class="stat-box box-psxg">
                <div><span class="stat-lbl">GOLES EVITADOS (PSxG)</span><span class="stat-val" style="color:${psxgColor}">${psxgSign}${psxgRaw.toFixed(2)}</span></div>
                <div style="text-align:right"><span class="stat-lbl">xGOT RECIBIDO</span><span class="stat-val" style="font-size:0.9rem">${s.xg_total.toFixed(2)}</span></div>
            </div>
        `;
    }

    // --- EXPORT ---
    function downloadCSV() {
        let csv = "Jornada,Portero,Categoria,Accion,Variante,Res,xGOT\n";
        store.actions.forEach(a => {
            const gkName = (store.gks.find(g => g.id == a.gk)?.name) || ('GK ' + a.gk);
            const matchLabel = a.match === 'single' ? 'Partido Unico' : a.match;
            csv += `${matchLabel},${gkName},${a.cat},${a.key},${a.var},${a.res},${a.xgot || 0}\n`;
        });
        const b = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b); a.download = 'GK_Data_Elite.csv'; a.click();
    }

    init();
</script>
</body>
</html>