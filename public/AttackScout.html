<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attack Scout Pro v5.1</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/app-data-manager.js"></script>

    <style>
        /* --- ESTILOS GENERALES (DARK MODE) --- */
        :root { 
            --bg: #0f0f0f; --panel: #1a1a1a; --border: #333;
            --accent: #00e676; --secondary: #2980b9; --text: #ecf0f1; --text-muted: #888;
        }
        * { box-sizing: border-box; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #000; border-bottom: 1px solid var(--border); }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 900; letter-spacing: 1px; }
        h1 span { color: var(--accent); }
        
        /* TABS */
        .tabs { display: flex; gap: 5px; }
        .tab-btn { background: #222; border: 1px solid var(--border); color: #888; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .tab-btn.active { background: var(--secondary); color: #fff; border-color: var(--secondary); }

        /* LAYOUT */
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 360px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px; overflow-y: auto; flex-shrink: 0; }
        
        /* CONTROLES */
        .control-group { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #333; }
        .control-group label { display: block; font-size: 0.7rem; color: var(--text-muted); font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        
        input[type="file"], select, input[type="number"] { width: 100%; background: #111; color: #fff; border: 1px solid var(--border); padding: 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 5px; }
        
        .filter-row { display: flex; gap: 5px; }
        
        button.btn-main { width: 100%; background: var(--accent); color: #000; border: none; padding: 10px; font-weight: 800; cursor: pointer; border-radius: 4px; margin-top: 5px; transition: 0.2s; }
        button.btn-main:hover { filter: brightness(1.1); transform: scale(1.02); }
        button:disabled { background: #444; cursor: not-allowed; transform: none; }

        /* SLIDERS */
        .slider-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; font-size: 0.75rem; }
        .slider-row span { width: 70px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .slider-row input { flex: 1; margin: 0 10px; accent-color: var(--accent); cursor: pointer; height: 4px; }
        .slider-val { width: 30px; text-align: right; color: var(--accent); font-weight: bold; }

        /* COLA DE ARCHIVOS */
        .file-queue { background: #222; border: 1px solid #333; border-radius: 4px; padding: 8px; max-height: 150px; overflow-y: auto; display: none; margin-top: 8px; }
        .file-queue.active { display: block; }
        .file-item { background: #1a1a1a; padding: 8px; border-radius: 3px; margin-bottom: 6px; border-left: 3px solid #f39c12; }
        .file-name { font-size: 0.7rem; font-weight: bold; margin-bottom: 4px; }
        .file-btns { display: flex; gap: 3px; }
        .f-btn { padding: 4px 8px; border: none; border-radius: 2px; font-size: 0.65rem; cursor: pointer; font-weight: bold; flex: 1; }
        .f-btn-ok { background: #27ae60; color: white; }
        .f-btn-ok:hover { background: #2ecc71; }
        .f-btn-skip { background: #555; color: white; }
        .f-btn-skip:hover { background: #666; }

        /* RESULTADOS - M√ÅS GRANDES */
        .player-list { flex: 1; overflow-y: auto; margin-top: 5px; }
        .player-card { background: #151515; padding: 12px; border-radius: 4px; border: 1px solid #333; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; min-height: 60px; }
        .player-card:hover { background: #222; border-color: #555; }
        .player-card.active { border-left: 4px solid var(--accent); background: #222; }
        .pc-info { flex: 1; }
        .pc-info b { display: block; font-size: 0.9rem; margin-bottom: 2px; }
        .pc-info span { font-size: 0.75rem; color: #888; line-height: 1.3; }
        .pc-score { font-weight: bold; font-size: 0.85rem; padding: 6px 10px; border-radius: 4px; background: #333; min-width: 55px; text-align: center; }

        /* CONTENT AREA */
        .content-area { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow: hidden; position: relative; background: #121212; }
        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }

        /* PIZZA CHART AREA */
        .chart-wrapper { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; min-height: 0; padding: 20px; }
        .print-btn { position: absolute; top: 0; right: 0; background: #333; color: #fff; border: 1px solid #555; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; z-index: 10; }

        /* TABLA DE AN√ÅLISIS */
        .analysis-panel { height: 30%; background: #1a1a1a; border-top: 1px solid #333; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
        .stat-bars { display: flex; flex-direction: column; gap: 8px; }
        .stat-row { display: flex; align-items: center; font-size: 0.8rem; }
        .stat-label { width: 100px; color: #aaa; }
        .stat-track { flex: 1; background: #333; height: 8px; border-radius: 4px; margin: 0 10px; overflow: hidden; position: relative; }
        .stat-fill { height: 100%; background: var(--secondary); width: 0%; transition: width 1s ease; }
        .stat-val { width: 40px; text-align: right; font-weight: bold; }
        .stat-pct { width: 60px; text-align: right; color: var(--accent); font-size: 0.75rem; }

        /* IMPRESI√ìN */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: #fff; color: #000; display: block; height: auto; overflow: visible; }
            .sidebar, .tabs, .print-btn, header { display: none !important; }
            .content-area { padding: 0; display: block; }
            .view-section { display: none; }
            #viewProfile { display: block !important; }
            .chart-wrapper { height: 450px; page-break-inside: avoid; }
            .analysis-panel { height: auto; border: none; background: none; color: #000; }
            .stat-track { background: #eee; }
            .report-header { display: block !important; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; }
            .report-header h1 { font-size: 26px; margin-bottom: 5px; }
        }
        .report-header { display: none; }
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:999; display:none; justify-content:center; align-items:center; color: var(--accent); flex-direction: column; }
    </style>
</head>
<body>

<div id="loader">
    <div style="font-size:2rem; margin-bottom:10px;">‚öΩ</div>
    <div>Procesando archivo...</div>
</div>

<header>
    <h1>ATTACK<span>SCOUT</span> <span style="font-size:0.6em; color:#888;">PRO v5.1</span></h1>
    <div class="tabs">
        <div class="tab-btn active" onclick="switchTab('viewProfile', this)">üçï RADAR COMPARISON</div>
        <div class="tab-btn" onclick="switchTab('viewScatter', this)">üìâ SCATTER</div>
    </div>
</header>

<div class="main-layout">
    <div class="sidebar">
        <div class="control-group">
            <label>1. DATOS (XLSX) - UNO POR UNO</label>
            <input type="file" id="filesInput" accept=".xlsx" onchange="onFileSelected()">
            <div id="fileQueue" class="file-queue"></div>
        </div>

        <div class="control-group">
            <label>2. TARGET</label>
            <select id="targetSelect" disabled onchange="onTargetChange()"><option>Carga datos primero...</option></select>
        </div>

        <div class="control-group">
            <label>3. FILTROS</label>
            <select id="filterPos">
                <option value="">Todas las Posiciones</option>
            </select>
            <div class="filter-row">
                <input type="number" id="ageMin" placeholder="Edad M√≠n" min="15" max="45">
                <input type="number" id="ageMax" placeholder="Edad M√°x" min="15" max="45">
            </div>
        </div>

        <div class="control-group">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <label>4. PESOS ALGORITMO</label>
                <span style="font-size:0.6rem; cursor:pointer; color:var(--secondary);" onclick="resetWeights()">Reset</span>
            </div>
            <div id="slidersContainer"></div>
            <button class="btn-main" id="btnSearch" onclick="findSimilars()" disabled>üîç BUSCAR SIMILARES</button>
        </div>

        <div style="flex:1; display:flex; flex-direction:column; overflow:hidden; min-height: 0;">
            <label style="margin-bottom: 5px; font-size: 0.7rem;">JUGADORES COMPATIBLES</label>
            <div class="player-list" id="resultsList"></div>
        </div>
    </div>

    <div class="content-area">
        
        <div id="viewProfile" class="view-section active">
            <button class="print-btn" onclick="window.print()">üñ®Ô∏è PDF</button>

            <div class="report-header">
                <h1 id="printName">Nombre Jugador</h1>
                <div id="printInfo">Equipo | Edad | Posici√≥n</div>
            </div>

            <div class="chart-wrapper">
                <canvas id="pizzaChart"></canvas>
            </div>

            <div class="analysis-panel">
                <label style="color:#fff; margin-bottom:10px; display:block; font-size:0.8rem;">üìä AN√ÅLISIS DE RENDIMIENTO</label>
                <div id="statsBarsContainer" class="stat-bars"></div>
            </div>
        </div>

        <div id="viewScatter" class="view-section">
            <div style="background:#222; padding:10px; display:flex; gap:10px; border-radius:6px; margin-bottom:10px;">
                <select id="axisX" onchange="updateScatter()" style="margin:0; width:auto;"><option value="xThreat">xThreat</option></select>
                <select id="axisY" onchange="updateScatter()" style="margin:0; width:auto;"><option value="xBuild" selected>xBuild</option></select>
            </div>
            <div style="flex:1; position:relative; background:#151515; border-radius:8px; border:1px solid #333; padding:10px;">
                <canvas id="scatterChart"></canvas>
            </div>
        </div>

    </div>
</div>

<script>
// --- CONFIGURACI√ìN ---
const METRICS = ['xG', 'xBuild', 'xThreat', 'Creacion', 'Ataque', 'Defensa', 'Pases'];
const METRIC_LABELS = {
    'xG': 'Goles Esp.', 'xBuild': 'Construcci√≥n', 'xThreat': 'Amenaza (xT)',
    'Creacion': 'Creaci√≥n', 'Ataque': 'Ataque Dir.', 'Defensa': 'Defensa', 'Pases': 'Pases'
};

// --- CALIBRADO: L√çMITES FIJOS PARA RADAR ---
const MAX_LIMITS = {
    'xG': 1.2,         
    'xBuild': 1.5,     
    'xThreat': 1.0,    
    'Creacion': 30.0,  
    'Ataque': 15.0,    
    'Defensa': 15.0,   
    'Pases': 60.0      
};

// Variables globales
let RAW_DB = [], NORMALIZED_DB = [], WEIGHTS = {}, chartInstance = null, scatterInstance = null;
let POSITIONS_FOUND = new Set();
let currentTarget = null;
let fileQueue = [];

window.onload = () => { 
    renderSliders(); 
    resetWeights(); 
};

// --- COLA DE CARGA (UNO POR UNO) ---
function onFileSelected() {
    const input = document.getElementById('filesInput');
    if(!input.files.length) return;
    
    fileQueue = Array.from(input.files);
    renderFileQueue();
}

function renderFileQueue() {
    const qDiv = document.getElementById('fileQueue');
    qDiv.innerHTML = '';
    
    if(fileQueue.length === 0) {
        qDiv.classList.remove('active');
        return;
    }
    
    qDiv.classList.add('active');
    
    fileQueue.forEach((f, idx) => {
        const el = document.createElement('div');
        el.className = 'file-item';
        el.innerHTML = `
            <div class="file-name">üìÑ ${f.name}</div>
            <div class="file-btns">
                <button class="f-btn f-btn-ok" onclick="processFile(${idx})">‚úì Cargar</button>
                <button class="f-btn f-btn-skip" onclick="skipFile(${idx})">‚äó Saltar</button>
            </div>
        `;
        qDiv.appendChild(el);
    });
}

async function processFile(idx) {
    if(idx >= fileQueue.length) return;
    
    const f = fileQueue[idx];
    document.getElementById('loader').style.display = 'flex';
    
    await new Promise(res => {
        const r = new FileReader();
        r.onload = e => {
            try {
                const wb = XLSX.read(e.target.result, {type:'array'});
                const ws = wb.Sheets["Jugadores"] || Object.values(wb.Sheets)[0];
                if(ws) {
                    const pMap = {};
                    XLSX.utils.sheet_to_json(ws).forEach(row => {
                        const name = row["Jugador"];
                        if(!name) return;
                        const team = row["Equipo"] || "Free Agent";
                        const pos = row["Posicion"] || "N/A";
                        const age = row["Edad"] || 25;
                        if(pos !== "N/A") POSITIONS_FOUND.add(pos);

                        const id = `${name}|${team}`;
                        if(!pMap[id]) pMap[id] = { id, name, team, pos, age, matches:0, stats:{} };
                        pMap[id].matches++;
                        METRICS.forEach(m => {
                            if(!pMap[id].stats[m]) pMap[id].stats[m] = 0;
                            pMap[id].stats[m] += (row[m] || 0);
                        });
                    });

                    Object.values(pMap).forEach(p => {
                        const obj = { id:p.id, name:p.name, team:p.team, pos:p.pos, age:p.age };
                        METRICS.forEach(m => obj[m] = p.stats[m] / p.matches);
                        const existing = RAW_DB.find(x => x.id === obj.id);
                        if(existing) RAW_DB.splice(RAW_DB.indexOf(existing), 1);
                        RAW_DB.push(obj);
                    });
                }
            } catch(err) { console.error(err); }
            res();
        };
        r.readAsArrayBuffer(f);
    });
    
    fileQueue.splice(idx, 1);
    renderFileQueue();
    
    if(fileQueue.length > 0) {
        document.getElementById('loader').style.display = 'none';
    } else {
        normalizeData();
        populateUI();
        document.getElementById('loader').style.display = 'none';
        document.getElementById('targetSelect').disabled = false;
        document.getElementById('btnSearch').disabled = false;
    }
}

function skipFile(idx) {
    fileQueue.splice(idx, 1);
    renderFileQueue();
}

// --- UI ---
function switchTab(id, btn) {
    document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
    btn.classList.add('active');
    if(id === 'viewScatter' && RAW_DB.length) updateScatter();
}

function renderSliders() {
    const c = document.getElementById('slidersContainer');
    c.innerHTML = METRICS.map(m => `
        <div class="slider-row">
            <span>${METRIC_LABELS[m]}</span>
            <input type="range" id="w_${m}" min="0" max="100" value="50" oninput="updateW('${m}',this.value)">
            <div id="val_${m}" class="slider-val">0.5</div>
        </div>`).join('');
}
function updateW(m, v) { WEIGHTS[m] = parseFloat((v/100).toFixed(1)); document.getElementById(`val_${m}`).innerText = WEIGHTS[m]; }
function resetWeights() { METRICS.forEach(m => { document.getElementById(`w_${m}`).value=50; updateW(m,50); }); }

// --- NORMALIZACI√ìN CON L√çMITES FIJOS ---
function normalizeData() {
    NORMALIZED_DB = RAW_DB.map(p => {
        const n = { ...p, raw: { ...p } };
        METRICS.forEach(m => {
            const val = p[m] || 0;
            const max = MAX_LIMITS[m] || 1;
            let norm = val / max;
            if(norm > 1) norm = 1;
            n[m] = norm;
        });
        return n;
    });
}

function populateUI() {
    const sel = document.getElementById('targetSelect');
    sel.innerHTML = '<option value="">Selecciona Jugador...</option>';
    RAW_DB.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.text = `${p.name} (${p.team})`;
        sel.appendChild(opt);
    });
    const posSel = document.getElementById('filterPos');
    posSel.innerHTML = '<option value="">Todas las Posiciones</option>';
    Array.from(POSITIONS_FOUND).sort().forEach(pos => {
        const opt = document.createElement('option');
        opt.value = pos;
        opt.text = pos;
        posSel.appendChild(opt);
    });
    ['axisX','axisY'].forEach(id => {
        const el = document.getElementById(id);
        el.innerHTML = METRICS.map(m => `<option value="${m}">${METRIC_LABELS[m]}</option>`).join('');
        if(id==='axisY') el.value = METRICS[1];
    });
}

// --- B√öSQUEDA ---
function onTargetChange() { document.getElementById('btnSearch').click(); }

function findSimilars() {
    const targetId = document.getElementById('targetSelect').value;
    if(!targetId) return;
    
    currentTarget = NORMALIZED_DB.find(p => p.id === targetId);
    
    const fPos = document.getElementById('filterPos').value;
    const fMin = parseInt(document.getElementById('ageMin').value) || 0;
    const fMax = parseInt(document.getElementById('ageMax').value) || 100;

    const pool = NORMALIZED_DB.filter(p => {
        if(p.id === targetId) return false;
        if(fPos && p.pos !== fPos) return false;
        if(p.age < fMin || p.age > fMax) return false;
        return true;
    });

    const results = pool.map(other => {
        let sumSq = 0, sumW = 0;
        METRICS.forEach(m => {
            const diff = currentTarget[m] - other[m];
            sumSq += (diff*diff) * WEIGHTS[m];
            sumW += WEIGHTS[m];
        });
        const dist = sumW > 0 ? Math.sqrt(sumSq/sumW) : 1;
        const sim = Math.max(0, 100 - (dist*100*1.5));
        return { ...other, similarity: sim };
    });

    results.sort((a,b) => b.similarity - a.similarity);
    renderResults(results.slice(0, 15));
    updateProfile(currentTarget, null); 
}

function renderResults(list) {
    const div = document.getElementById('resultsList');
    div.innerHTML = '';
    list.forEach(p => {
        const el = document.createElement('div');
        el.className = 'player-card';
        const c = p.similarity > 90 ? '#00e676' : (p.similarity>80 ? '#f1c40f' : '#e74c3c');
        el.innerHTML = `
            <div class="pc-info"><b>${p.name}</b><span>${p.team} | ${p.pos} | ${p.age} a√±os</span></div>
            <div class="pc-score" style="color:${c}">${p.similarity.toFixed(0)}%</div>
        `;
        el.onclick = () => {
            document.querySelectorAll('.player-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            updateProfile(currentTarget, p);
        };
        div.appendChild(el);
    });
}

// --- GR√ÅFICO RADAR ---
function updateProfile(target, comparison) {
    const compText = comparison ? ` vs ${comparison.name}` : '';
    document.getElementById('printName').innerText = target.name + compText;
    document.getElementById('printInfo').innerText = `${target.team} | ${target.pos}`;

    const ctx = document.getElementById('pizzaChart').getContext('2d');
    if(chartInstance) chartInstance.destroy();

    const datasets = [
        {
            label: target.name,
            data: METRICS.map(m => target[m]*100),
            backgroundColor: 'rgba(0, 230, 118, 0.5)',
            borderColor: '#00e676',
            borderWidth: 2,
            pointRadius: 3
        }
    ];

    if(comparison) {
        datasets.push({
            label: comparison.name,
            data: METRICS.map(m => comparison[m]*100),
            backgroundColor: 'rgba(41, 128, 185, 0.5)',
            borderColor: '#3498db',
            borderWidth: 2,
            pointRadius: 3
        });
    }

    chartInstance = new Chart(ctx, {
        type: 'radar',
        data: { labels: METRICS.map(m => METRIC_LABELS[m]), datasets: datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                r: {
                    angleLines: { color: '#333' },
                    grid: { color: '#333' },
                    pointLabels: { color: '#ccc', font: { size: 11 } },
                    ticks: { display: false, backdropColor: 'transparent' },
                    min: 0, max: 100
                }
            },
            plugins: {
                legend: { position: 'top', labels: { color: '#fff' } },
                tooltip: { 
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    callbacks: { label: (c) => `${c.dataset.label}: ${c.raw.toFixed(0)}` } 
                }
            }
        }
    });

    const container = document.getElementById('statsBarsContainer');
    container.innerHTML = '';

    METRICS.forEach(m => {
        const tVal = target.raw[m];
        const tPct = (target[m] * 100).toFixed(0);
        
        let compMarker = '';
        if(comparison) {
            const cPct = (comparison[m] * 100).toFixed(0);
            compMarker = `<div style="position:absolute; top:-4px; left:${cPct}%; width:4px; height:14px; background:#3498db; z-index:5; box-shadow:0 0 5px #000;" title="${comparison.name}: ${cPct}%"></div>`;
        }

        const color = tPct > 80 ? '#00e676' : (tPct > 50 ? '#f1c40f' : '#e74c3c');
        
        container.innerHTML += `
            <div class="stat-row">
                <div class="stat-label">${METRIC_LABELS[m]}</div>
                <div class="stat-track">
                    ${compMarker}
                    <div class="stat-fill" style="width:${tPct}%; background:${color}"></div>
                </div>
                <div class="stat-val">${tVal.toFixed(2)}</div>
                <div class="stat-pct">${tPct}%</div>
            </div>
        `;
    });
}

function updateScatter() {
    const xK = document.getElementById('axisX').value;
    const yK = document.getElementById('axisY').value;
    const ctx = document.getElementById('scatterChart').getContext('2d');
    const fPos = document.getElementById('filterPos').value;
    const data = RAW_DB.filter(p => !fPos || p.pos === fPos).map(p => ({ x:p[xK], y:p[yK], n:p.name, t:p.team }));

    if(scatterInstance) scatterInstance.destroy();
    scatterInstance = new Chart(ctx, {
        type: 'scatter',
        data: { datasets: [{ label: 'Jugadores', data: data, backgroundColor: '#00e676', pointRadius:3 }] },
        options: {
            responsive:true, maintainAspectRatio:false,
            scales: {
                x: { grid:{color:'#333'}, title:{display:true,text:METRIC_LABELS[xK],color:'#888'} },
                y: { grid:{color:'#333'}, title:{display:true,text:METRIC_LABELS[yK],color:'#888'} }
            },
            plugins: { legend:{display:false}, tooltip: { callbacks: { label: (c)=> `${c.raw.n} (${c.raw.t})` } } }
        }
    });
}
</script>
</body>
</html>
